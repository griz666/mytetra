<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Управление реле Лоран через систему автоматизации умного дома OpenHab </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post-body-3570233964965634255"></a><span style=" font-family:'Sans Serif'; font-size:9pt;">Р</span><span style=" font-family:'Sans Serif'; font-size:9pt;">ешил я начать с описания того, как управлять модулем Лоран в OpenHab. Будем считать что это в честь релиза OpenHab 2.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Я надеюсь, что это кому-то будет полезно, даже если и не для подключения Лорана, то просто как пример как это устроено, для того чтобы сделать что-то свое. Если будет интересно, буду еще писать про OpenHab, что я сам делал и с чем столкнулся</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Итак, на данный момент работать это управление может только через http, и режим защиты модуля должен быть отключен. В принципе, можно слать команды и в tcp. Но как это сделать так, чтобы он сначала посылал пароль, а потом команду - я пока не знаю. У меня есть кое-какие идеи, но в лоб это сделать нельзя, поэтому отложим это на потом.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Я называл свой тестовый модуль Laurent 4, IP-адрес у него 192.168.0.104, http-команды соответствующие.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Должны быть установлены аддоны:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">HTTP Binding</li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">RegEx Transformation</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Я советую не копировать отсюда части кода, а брать их прямо из файлов примеров, потому как в коде есть треугольные скобки и тэги, и при их отображении может случиться какой-нибудь косяк.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Сначала создаем устройства. За них отвечают файлы в папке ПАПКА_OPENHAB\conf\items с расширением items. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Создадим файл Laurent4.items. Например, выключатель для реле 1 будет там выглядеть так: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Switch Laurent4Relay1 &quot;Реле 1&quot; &lt;light&gt; (gLaurent4, gSwitches) {http=&quot;&gt;[ON:GET:http://192.168.0.104/cmd.cgi?cmd=REL,1,1] &gt;[OFF:GET:http://192.168.0.104/cmd.cgi?cmd=REL,1,0]&quot; } </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Прочитать это можно следующим образом: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Выключатель с внутренним именем Laurent4Relay1 (имя может быть любое, но уникальное), с именем в интерфейсе Реле 1 (если потом не будет указано другое), с динамической картинкой, в начале названия которой слово light (не обязательно), входящий в группы gLaurent4 и gSwitches (не обязательно), использующий http, посылающий команду http://192.168.0.104/cmd.cgi?cmd=REL,1,1 при переводе в состояние ON и посылающий команду http://192.168.0.104/cmd.cgi?cmd=REL,1,0 при переводе в состояние OFF.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Соответственно, выходная линия будет выглядеть так:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Switch Laurent4Outline1 &quot;Выходная линия 1&quot; &lt;light&gt; (gLaurent4, gSwitches) {http=&quot;&gt;[ON:GET:http://192.168.0.104/cmd.cgi?cmd=OUT,1,1] &gt;[OFF:GET:http://192.168.0.104/cmd.cgi?cmd=OUT,1,0]&quot; } </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Датчик температуры также сделать очень легко и выглядеть он будет так: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Number Laurent4Temp &quot;Температура [%.1f °C]&quot; &lt;temperature&gt; (gLaurent4, gSensors) {http=&quot;&lt;[http://192.168.0.104/state.xml:10000:REGEX(.*?&lt;temp&gt;(.*?)&lt;/temp&gt;.*)]&quot; } </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Прочитать это можно следующим образом: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Числовое значение с внутренним именем Laurent4Temp (имя может быть любое, но уникальное), с именем в интерфейсе Температура (если потом не будет указано другое), с точностью один знак после запятой, после значения будет добавлено слово °C, с картинкой с названием temperature, входящее в группы gLaurent4 и gSensors (не обязательно), использующее http, что-то принимающее, находящееся по адресу http://192.168.0.104/state.xml, обновляющееся каждые 10000 милисекунд, извлекающее информацию из файла с помощью регулярного выражения, (не даваясь в подробности) нужное значение находится между словами &lt;temp&gt; и &lt;/temp&gt;.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">За отображение всех компоненентов отвечают файлы в папке ПАПКА_OPENHAB\conf\sitemaps с расширением sitemap. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Создадим файл Laurent4.sitemap. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">И пишем там: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Switch item=Laurent4Relay1</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Switch item=Laurent4Outline1</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Text item=Laurent4Temp valuecolor=[ ==&quot;NULL&quot; = &quot;lightgray &quot;, &gt; 30 = &quot;red&quot;, &gt;= 27 =&quot;yellow&quot; , &gt;= 23 = &quot;green&quot;, &lt; 23 = &quot;aqua&quot; ] </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Тут я думаю все понятно, но только еще есть бонус в виде valuecolor, означающее следующее: если значения нет, цвет будет серым, если значение больше 30 - цвет будет красный, больше либо равно 27 - желтый, больше либо равно 23 - зеленый, меньше 23 - голубой.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">В принципе это уже работоспособно. Но тут, к сожалению, нет обратной связи, а также нет информации со входных линий. Вот это уже сущственно сложнее, однако, мы продолжаем.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Добавляем в файл Laurent4.items следующие виртуальные устройства, которые нужны нам будут только для получения значений из Лорана:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">String Laurent4RelayString &quot;Laurent 4 Relay String: [%s]&quot;{http=&quot;&lt;[http://192.168.0.104/state.xml:6900:REGEX(.*?&lt;rele&gt;(.*?)&lt;/rele&gt;.*)]&quot; } </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">String Laurent4OutlineString &quot;Laurent 4 Outline String: [%s]&quot; {http=&quot;&lt;[http://192.168.0.104/state.xml:7000:REGEX(.*?&lt;out&gt;(.*?)&lt;/out&gt;.*)]&quot; } </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">String Laurent4InlineString &quot;Laurent 4 Inline String: [%s]&quot; {http=&quot;&lt;[http://192.168.0.104/state.xml:1000:REGEX(.*?&lt;in&gt;(.*?)&lt;/in&gt;.*)]&quot; } </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Не буду вдаваться в подробности, это устроено аналогично получению температуры, смысл в том, что мы получаем строчки с актуальными состояниями наших реле, входных и выходных линий, состоящие из единиц и нулей, например 1001 для реле, когда включены первое и четвертое реле.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Теперь эти строки предстоит обработать, извлечь оттуда индивидуальные значения для элементов и назначить этим элементам. Делать это придется через правила.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Правила - это файлы в папке ПАПКА_OPENHAB\conf\rules с расширением rules. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Я не буду описывать здесь все что там происходит, я думаю, комментариев в файле будет достаточно.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Таким образом, советую скачать тестовые файлы, которые нужно поместить в соответсвующие папки.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Кроме того, желательно поместить в нужную папку также и следующие иконки:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">light.svg</li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">light-off.svg</li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">light-on.svg</li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">temperature.svg</li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">window.svg</li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">window-closed.svg</li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">window-open.svg</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">(Формат svg используется по умолчанию, можно в настройках указать png)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Папка для иконок такая: ПАПКА_OPENHAB\conf\icons\classic</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Взять их можно здесь, например: </span><a href="https://github.com/eclipse/smarthome/tree/master/extensions/ui/iconset/org.eclipse.smarthome.ui.iconset.classic"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">https://github.com/eclipse/smarthome/tree/master/extensions/ui/iconset/org.eclipse.smarthome.ui.iconset.classic</span></a></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Чтобы подключиться к интерфейсу, в браузере вводим его адрес. У меня, например, </span><a href="http://localhost:8080/basicui/app?sitemap=Laurent4"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">http://localhost:8080/basicui/app?sitemap=Laurent4</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image16063141549y18cd8rk5.png" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Да, да, выглядит немного страшновато, но мы сейчас не о том. Интерфейс можно сделать любой, использовать любые иконки (из Fibaro, например), подключить ImperiHome, сделать HabPanel и т.д. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Главное - все работает! </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Ссылка на файлы: </span><a href="https://drive.google.com/file/d/0B6bs8cRm74Rlc053ZlBkbEM4UHM/"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">https://drive.google.com/file/d/0B6bs8cRm74Rlc053ZlBkbEM4UHM/</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;"> </span></p></body></html>