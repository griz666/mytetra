<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Удивительно полезный инструмент: lsof </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://medium.com/@copyconstruct/lsof-f2b224eee7b5"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">Автор оригинала: Cindy Sridharan</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;"> </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habr.com/ru/company/ruvds/"><span style=" text-decoration: underline; color:#0000ff;">Блог компании RUVDS.com</span></a>, </li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habr.com/ru/hub/linux/"><span style=" text-decoration: underline; color:#0000ff;">Настройка Linux</span></a>, </li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habr.com/ru/hub/sys_admin/"><span style=" text-decoration: underline; color:#0000ff;">Системное администрирование</span></a> </li></ul>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Перевод </li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Я привык искать проблемы в коде или в системе, пользуясь логами или показателями мониторинга, которые выводятся на симпатичных панелях управления с простым и понятным интерфейсом. Однако, если по какой-то причине данные на панель управления не поступают, или логи какой-нибудь службы недоступны, отладка усложняется. Теперь подобных проблем немного, встречаются они редко, но они, всё же, случаются. Поэтому и в наше время весьма ценно знание инструментов, которые помогают понять, что не так с неким процессом на каком-нибудь компьютере.<br /><br /></span></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="habracut"></a><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt;">Когда я отлаживаю нечто, для чего нет логов или показателей мониторинга, я подключаюсь к удалённому компьютеру по ssh. Конечно, это подход ограниченный, он не так уж и прост, не соответствует модным веяниям DevOps, или всем тем современным штучкам, которых можно начитаться в интернете, но он на удивление хорошо подходит мне для того, чтобы быстро проанализировать ситуацию.<br /><br />Это, на самом деле, похоже на использование команды </span><span style=" font-family:'monospace'; font-size:9pt;">print</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> при отладке программ. Тут мне сразу хотелось бы уточнить, что я не SRE и не инженер по эксплуатации в сфере IT. Основная сфера моей деятельности — разработка.<br /><br />Иногда мне приходится разворачивать код, который я написал, и отлаживать его, когда что-то идёт не так. Почти всегда, когда я оказываюсь в новой для себя системе, самым сложным для меня оказывается </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic; color:#999999;">поиск чего-либо</span><span style=" font-family:'Sans Serif'; font-size:9pt;">. Например — выяснить, какой порт прослушивает процесс. Или, что требуется чаще, узнать, в какой файл пишет логи некий демон. И если даже мне удаётся найти ответы на эти вопросы, воспользовавшись кучей вызовов команд </span><span style=" font-family:'monospace'; font-size:9pt;">ps</span><span style=" font-family:'Sans Serif'; font-size:9pt;">, </span><span style=" font-family:'monospace'; font-size:9pt;">pstree</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> и </span><span style=" font-family:'monospace'; font-size:9pt;">ls</span><span style=" font-family:'Sans Serif'; font-size:9pt;">, и великим множеством обращений к команде </span><span style=" font-family:'monospace'; font-size:9pt;">grep</span><span style=" font-family:'Sans Serif'; font-size:9pt;">, часто «ответы», которые я нахожу, либо не содержат ничего полезного, либо оказываются неверными.<br /><br />Если бы то, что вы сейчас читаете, было бы выступлением Раймонда Геттингера, ведущего разработчика CPython, тут настал бы момент, когда аудитория ждёт фразы: «должен быть лучший способ».<br /><br />И, на самом деле, такой способ есть. Средством, которым я постоянно пользуюсь для поиска в системе того, что мне нужно, стал отличный инструмент, который называется </span><span style=" font-family:'monospace'; font-size:9pt;">lsof</span><span style=" font-family:'Sans Serif'; font-size:9pt;">.<br /><br />Утилита </span><span style=" font-family:'monospace'; font-size:9pt;">lsof</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> (её название звучит как el-soff, хотя некоторым больше нравится нечто вроде liss-off или даже el-es-o-eff) — это невероятно полезная команда, которая выводит список всех открытых файлов (LiSts all Open Files).<br /><br />Команд </span><span style=" font-family:'monospace'; font-size:9pt;">lsof</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> особенно хороша для поиска чего-либо, так как в Unix-подобных системах всё является файлом. Это — на удивление универсальный отладочный инструмент, который довольно легко способен заменить утилиты </span><span style=" font-family:'monospace'; font-size:9pt;">ps</span><span style=" font-family:'Sans Serif'; font-size:9pt;">, </span><span style=" font-family:'monospace'; font-size:9pt;">netstat</span><span style=" font-family:'Sans Serif'; font-size:9pt;">, да и некоторые другие тоже.<br /><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; color:#3ac1ef;">Опции lsof</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Ветеран SRE, который занимался этим делом за десятилетия до того, как появился термин «SRE», однажды сказал мне: «Я перестал изучать опции lsof как только узнал все те, которые мне нужны. Изучи самое важное, и это будет всем, что тебе когда-либо понадобится».<br /><br />Утилита </span><span style=" font-family:'monospace'; font-size:9pt;">lsof</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> имеет обширный набор опций.<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">NAME</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">lsof - list open files</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">SYNOPSIS</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">lsof  [  -?abChKlnNOPRtUvVX  ]  [ -A A ] [ -c c ] [ +c c ] [ +|-d d ] [+|-D D ] [ +|-e s ] [ +|-f [cfgGn] ] [ -F [f] ] [ -g [s] ] [ -i [i] ] [-k  k  ]  [  +|-L  [l] ] [ +|-m m ] [ +|-M ] [ -o [o] ] [ -p s ] [ +|-r[t[m&lt;fmt&gt;]] ] [ -s [p:s] ] [ -S [t] ] [ -T [t] ] [ -u s ] [ +|-w ] [ -x[fl] ] [ -z [z] ] [ -Z [Z] ] [ -- ] [names]</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Если вы хотите изучит их все — </span><a href="https://linux.die.net/man/8/lsof"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">man</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;"> вам в помощь. Здесь же мне хотелось бы рассказать о тех, которыми обычно пользуюсь я.<br /><br /></span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; color:#3ac1ef;">▍Опция -u</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Опция </span><span style=" font-family:'monospace'; font-size:9pt;">-u</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> выводит список файлов, открытых конкретным пользователем. Следующий пример показывает, как можно узнать, сколько файлов держит открытыми пользователь </span><span style=" font-family:'monospace'; font-size:9pt;">cindy</span><span style=" font-family:'Sans Serif'; font-size:9pt;">.<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">cindy@ubuntu:~$ lsof -u cindy | wc -l</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">248</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Обычно, если перед параметром некоей опции ставят знак «^» (крышка), который означает отрицание, это приводит к исключению файлов, соответствующих данному параметру, из вывода программы. Вот, например, как можно узнать количество файлов на компьютере, которые открыты всеми пользователями за исключением </span><span style=" font-family:'monospace'; font-size:9pt;">cindy</span><span style=" font-family:'Sans Serif'; font-size:9pt;">.<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">cindy@ubuntu:~$ lsof -u^cindy | wc -l</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">38193</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; color:#3ac1ef;">▍Опция -U</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Опция </span><span style=" font-family:'monospace'; font-size:9pt;">-U</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> позволяет вывести все файлы сокетов домена Unix.<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">cindy@ubuntu:~$ lsof -U | head -5</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">COMMAND     PID       USER   FD   TYPE             DEVICE SIZE/OFF    NODE NAME</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">init          1       root    7u  unix 0xffff88086a171f80      0t0   24598 @/com/ubuntu/upstart</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">init          1       root    9u  unix 0xffff88046a22b480      0t0   22701 socket</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">init          1       root   10u  unix 0xffff88086a351180      0t0   39003 @/com/ubuntu/upstart</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">init          1       root   11u  unix 0xffff880469006580      0t0   16510 @/com/ubuntu/upstart</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; color:#3ac1ef;">▍Опция -c</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Опция </span><span style=" font-family:'monospace'; font-size:9pt;">-c</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> позволяет вывести сведения о файлах, которые держат открытыми процессы, выполняющие команды, имена которых начинаются с заданных символов. Например, вот какая команда позволит увидеть первые 15 файлов, открытых всеми процессами Python, выполняющимися на компьютере.<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">cindy@ubuntu:~$ lsof -cpython | head -15</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">COMMAND     PID USER   FD   TYPE             DEVICE SIZE/OFF       NODE NAME</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python2.7 16905 root  cwd    DIR                9,1     4096  271589387 /home/cindy/sourcebox</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python2.7 16905 root  rtd    DIR                9,1     4096       2048 /</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python2.7 16905 root  txt    REG                9,1  3345416  268757001 /usr/bin/python2.7</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python2.7 16905 root  mem    REG                9,1    11152 1610852447 /usr/lib/python2.7/lib-dynload/resource.x86_64-linux-gnu.so</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python2.7 16905 root  mem    REG                9,1   101240 1610899495 /lib/x86_64-linux-gnu/libresolv-2.19.so</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python2.7 16905 root  mem    REG                9,1    22952 1610899509 /lib/x86_64-linux-gnu/libnss_dns-2.19.so</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python2.7 16905 root  mem    REG                9,1    47712 1610899515 /lib/x86_64-linux-gnu/libnss_files-2.19.so</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python2.7 16905 root  mem    REG                9,1    33448 1610852462 /usr/lib/python2.7/lib-dynload/_multiprocessing.x86_64-linux-gnu.so</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python2.7 16905 root  mem    REG                9,1    54064 1610852477 /usr/lib/python2.7/lib-dynload/_json.x86_64-linux-gnu.so</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python2.7 16905 root  mem    REG                9,1    18936 1610619044 /lib/x86_64-linux-gnu/libuuid.so.1.3.0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python2.7 16905 root  mem    REG                9,1    30944 1207967802 /usr/lib/x86_64-linux-gnu/libffi.so.6.0.1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python2.7 16905 root  mem    REG                9,1   136232 1610852472 /usr/lib/python2.7/lib-dynload/_ctypes.x86_64-linux-gnu.so</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python2.7 16905 root  mem    REG                9,1    77752 1610852454 /usr/lib/python2.7/lib-dynload/parser.x86_64-linux-gnu.so</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python2.7 16905 root  mem    REG                9,1   387256 1610620979 /lib/x86_64-linux-gnu/libssl.so.1.0.0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Вот ещё интересный пример. Например, имеется некоторое количество процессов Python 2.7 и Python 3.6, при этом надо выяснить, какие файлы открыты процессами, которые не являются процессами Python 2.7. Сделать это можно так:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">cindy@ubuntu:~$ lsof -cpython -c^python2.7 | head -10</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF       NODE NAME</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python  20017 root  cwd    DIR    9,1     4096       2048 /</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python  20017 root  rtd    DIR    9,1     4096       2048 /</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python  20017 root  txt    REG    9,1  3345416  268757001 /usr/bin/python2.7</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python  20017 root  mem    REG    9,1    11152 1610852447 /usr/lib/python2.7/lib-dynload/resource.x86_64-linux-gnu.so</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python  20017 root  mem    REG    9,1     6256  805552236 /usr/lib/python2.7/dist-packages/_psutil_posix.x86_64-linux-gnu.so</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python  20017 root  mem    REG    9,1    14768  805552237 /usr/lib/python2.7/dist-packages/_psutil_linux.x86_64-linux-gnu.so</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python  20017 root  mem    REG    9,1    10592  805451779 /usr/lib/python2.7/dist-packages/Crypto/Util/strxor.x86_64-linux-gnu.so</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python  20017 root  mem    REG    9,1    11176 1744859170 /usr/lib/python2.7/dist-packages/Crypto/Cipher/_ARC4.x86_64-linux-gnu.so</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">python  20017 root  mem    REG    9,1    23560 1744859162 /usr/lib/python2.7/dist-packages/Crypto/Cipher/_Blowfish.x86_64-linux-gnu.so</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; color:#3ac1ef;">▍Опция +d</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Опция </span><span style=" font-family:'monospace'; font-size:9pt;">+d</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> позволяет выяснить, какие папки и файлы открыты в некоей директории (но не в её поддиректориях).<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">cindy@ubuntu:~$ lsof +d /usr/bin | head -4</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">COMMAND     PID     USER  FD   TYPE DEVICE SIZE/OFF   NODE NAME</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">circusd    1351     root txt    REG    9,1  3345416 268757001 /usr/bin/python2.7</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">docker     1363     root txt    REG    9,1 19605520 270753792 /usr/bin/docker</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">runsvdir   1597     root txt    REG    9,1    17144 272310314 /usr/bin/runsvdir</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; color:#3ac1ef;">▍Опция -d</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Пожалуй, опция </span><span style=" font-family:'monospace'; font-size:9pt;">-d</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> — это одна из тех, которыми я пользуюсь чаще всего. Уступает она только опции </span><span style=" font-family:'monospace'; font-size:9pt;">-p</span><span style=" font-family:'Sans Serif'; font-size:9pt;">. Эта опция позволяет задать список дескрипторов файлов, разделённых запятой, которые надо включить в вывод или исключить из него. Вот что говорит об этом документация:<br /><br /></span><span style=" font-family:'monospace'; font-size:9pt;">Список исключается из вывода, если все записи в наборе начинаются со знака «^». Список будет включён в вывод, если ни одна запись не начинается с «^». Смешивание записей разных видов не разрешается.<br /><br />В списке может присутствовать диапазон номеров дескрипторов файлов при условии, что ни один из его членов не пуст, оба члена являются числами, и завершающий член больше начального - то есть: «0-7» или «3-10».<br /><br />Диапазоны могут быть использованы для исключения записей из вывода, если перед ними стоит префикс «^», то есть - «^0-7» исключает все дескрипторы с 0 по 7.<br /><br />Вывод по нескольким номерам дескрипторов файлов объединяется в соответствии с правилами логического ИЛИ, в один набор, прежде чем к ним будет применена операция логического И.<br /><br />Когда в наборе встречаются и включаемые и исключаемые члены, lsof сообщает об ошибке и завершает работу с ненулевым кодом возврата.</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br /></span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; color:#3ac1ef;">▍Опция -p</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Не могу вспомнить, когда я не пользовался бы опцией </span><span style=" font-family:'monospace'; font-size:9pt;">-p</span><span style=" font-family:'Sans Serif'; font-size:9pt;">, работая с </span><span style=" font-family:'monospace'; font-size:9pt;">lsof</span><span style=" font-family:'Sans Serif'; font-size:9pt;">. Она позволяет вывести все файлы, открытые процессом с указанным при вызове команды PID.<br /><br />Например, вот как в Ubuntu выглядит вывод информации обо всех файлах, открытых процессом, скажем, с PID 1.<br /><br /></span><img src="image1571037851ot6feztpn5.png" /><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic; color:#999999;">Вывод команды lsof, вызванной с опцией -p в Ubuntu</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />Вот что выводится на моём MacBook Air.<br /><br /></span><img src="image15710378513sd9wnuaoc.png" /><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic; color:#999999;">Вывод команды lsof, вызванной с опцией -p на MacBook Air</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br /></span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; color:#3ac1ef;">▍Опция -P</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Опция </span><span style=" font-family:'monospace'; font-size:9pt;">-P</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> подавляет, для сетевых файлов, преобразование номеров портов в имена портов. Её полезно использовать в тех случаях, когда разрешение имён портов работает неправильно.<br /><br />Эту опцию можно использовать с другой опцией — </span><span style=" font-family:'monospace'; font-size:9pt;">-n</span><span style=" font-family:'Sans Serif'; font-size:9pt;">, которая подавляет преобразование сетевых номеров в имена хостов для сетевых файлов. Она, кроме того, полезна при неправильно работающем разрешении имён хостов.<br /><br />Подавление обоих вышеупомянутых преобразований </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic; color:#999999;">иногда</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> может ускорить работу </span><span style=" font-family:'monospace'; font-size:9pt;">lsof</span><span style=" font-family:'Sans Serif'; font-size:9pt;">.<br /><br /></span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; color:#3ac1ef;">▍Опция -i</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Опция </span><span style=" font-family:'monospace'; font-size:9pt;">-i</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> позволяет вывести сведения о файлах, интернет-адреса которых соответствуют заданному адресу. Если при вызове команды не задавать адреса, эта опция позволяет вывести сведения обо всех интернет-сокетах и сетевых файлах.<br /><br />С помощью </span><span style=" font-family:'monospace'; font-size:9pt;">lsof</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> можно, например, посмотреть на TCP-соединения, открытые клиентом Slack или Dropbox. Ради интереса попробуйте посмотреть, сколько соединений открывают вкладки Chrome, каждая из которых является отдельным процессом. Посмотрим на соединения, открытые Slack:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">lsof -i -a -u $USER | grep Slack</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><img src="image1571037851j8u5oml0f8.png" /><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic; color:#999999;">Вывод сведений о соединениях, которые открыл Slack</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />А вот что с помощью </span><span style=" font-family:'monospace'; font-size:9pt;">lsof</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> можно узнать о TCP-сокетах, открытых клиентом Dropbox:<br /><br /></span><img src="image15710378518jhezwt81h.png" /><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic; color:#999999;">Вывод сведений о соединениях, которые открыл Dropbox</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br /></span><span style=" font-family:'monospace'; font-size:9pt;">Lsof</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> позволяет просматривать и сведения об UDP-соединениях с помощью команды </span><span style=" font-family:'monospace'; font-size:9pt;">lsof -iUDP</span><span style=" font-family:'Sans Serif'; font-size:9pt;">.<br /><br /></span><img src="image1571037851d4p7ulu4vy.png" /><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic; color:#999999;">Вывод сведений об UDP-соединениях</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />С помощью команды </span><span style=" font-family:'monospace'; font-size:9pt;">lsof -i 6</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> можно вывести список открытых соединений IPv6.<br /><br /></span><img src="image1571037851hunrfbt1ro.png" /><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic; color:#999999;">Вывод сведений об IPv6-соединениях</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br /></span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; color:#3ac1ef;">▍Опция -t</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Опция </span><span style=" font-family:'monospace'; font-size:9pt;">-t</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> подавляет вывод всей информации за исключением ID процессов. Я часто использую её, если хочу перенаправить список PID какой-нибудь другой команде, в основном — </span><span style=" font-family:'monospace'; font-size:9pt;">kill-9</span><span style=" font-family:'Sans Serif'; font-size:9pt;">.<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">cindy@ubuntu:~$ lsof -t /var/log/dummy_svc.log</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">1235</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">2171</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">2188</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">2189</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">16758</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">16761</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">16762</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; color:#3ac1ef;">Комбинирование опций</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Обычно </span><span style=" font-family:'monospace'; font-size:9pt;">lsof</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> объединяет результаты использования нескольких опций, следуя принципу логического ИЛИ. Если задать опцию </span><span style=" font-family:'monospace'; font-size:9pt;">-a</span><span style=" font-family:'Sans Serif'; font-size:9pt;">, результаты будут объединены по правилам логического И.<br /><br />Конечно, есть несколько исключений из этого правила, тут, как обычно, рекомендовано взглянуть на документацию, но если в двух словах, то работает это так:<br /><br /></span><span style=" font-family:'monospace'; font-size:9pt;">Обычно заданные опции списка объединяются по принципу логического ИЛИ, то есть, если указать опцию -i без указания адреса, и опцию -u foo, будет выведен список всех сетевых файлов или файлов, принадлежащих процессам, владельцем которых является пользователь «foo». Из этого правила есть несколько исключений:<br /><br /></span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'monospace'; font-size:9pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Имя пользователя или ID пользователя (UID) со знаком «^» (отрицание), заданное с опцией -u;<br /></li>
<li style=" font-family:'monospace'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Идентификатор процесса (PID) со знаком «^» (отрицание), заданный с опцией -p;<br /></li>
<li style=" font-family:'monospace'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Группа процессов (PGID) со знаком «^» (отрицание), заданная с опцией -g;<br /></li>
<li style=" font-family:'monospace'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Имя команды со знаком «^» (отрицание), заданное с опцией -c;<br /></li>
<li style=" font-family:'monospace'; font-size:9pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Имена состояний протоколов TCP или UDP, заданные с опцией -s [p:s].<br /></li></ol>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;"><br />Так как всё это - команды для исключения результатов из вывода, они применяются без использования принципов логического ИЛИ или И, они воздействуют на вывод команды до применения любых других критериев отбора.<br /><br />Опцию -a можно использовать для обработки вывода по принципу логического И. Например, если использовать опции -a, -U и -u foo, будет выведен список только файлов сокетов UNIX, которые принадлежат процессам, владельцем которых является пользователь «foo».</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; color:#3ac1ef;">История большой победы</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Пожалуй, я тут немного преувеличиваю, «победа» была не такой уж и большой, но когда случилось то, о чём пойдёт речь, </span><span style=" font-family:'monospace'; font-size:9pt;">lsof</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> оказался очень кстати.<br /><br />Пару недель назад мне нужно было поднять один экземпляр нового сервиса в тестовом окружении. Тестовый сервис, о котором идёт речь, не был подключён к рабочей инфраструктуре мониторинга. Я попытался выяснить, почему процесс, который был только что запущен, не зарегистрировал себя в Consul, как результат, его не могли обнаружить другие сервисы. «Так, не знаю, в чём дело, но взгляну-ка я на логи», — подумал я. Если что-то работает не так, как ожидается, я смотрю логи сервиса, работу которого пытаюсь наладить, и в большинстве случаев логи сразу указывают на корень проблемы.<br /><br />Сервис, о котором идёт речь, запускался с использованием менеджера процессов и сокетов </span><a href="https://circus.readthedocs.io/en/latest/"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">circus</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;">. Логи для процессов, работающих под </span><span style=" font-family:'monospace'; font-size:9pt;">circus</span><span style=" font-family:'Sans Serif'; font-size:9pt;">, хранятся в специальном месте на хосте — назовём его </span><span style=" font-family:'monospace'; font-size:9pt;">/var/log/circusd</span><span style=" font-family:'Sans Serif'; font-size:9pt;">. Более новые сервисы на хосте запускались другим менеджером, </span><a href="http://skarnet.org/software/s6/"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">s6</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;">, который пишет логи в другое место. Затем, есть ещё и логи, которые генерирует </span><span style=" font-family:'monospace'; font-size:9pt;">socklog/svlogd,</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> которые, опять же, оказываются где-то ещё. Короче говоря, в логах недостатка не было, и главная проблема заключалась в том, чтобы обнаружить, в какой дескриптор файла пишет лог мой сбойный процесс.<br /><br />Так как я знал, что процесс, с проблемами которого я пытался разобраться, работает под </span><span style=" font-family:'monospace'; font-size:9pt;">circus</span><span style=" font-family:'Sans Serif'; font-size:9pt;">, подключение с помощью команды </span><span style=" font-family:'monospace'; font-size:9pt;">tail</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> к </span><span style=" font-family:'monospace'; font-size:9pt;">/var/log/circusd/whatever_tab_completion_suggested</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> позволило бы мне посмотреть на потоки </span><span style=" font-family:'monospace'; font-size:9pt;">stdout</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> и </span><span style=" font-family:'monospace'; font-size:9pt;">stderr</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> этого процесса. Правда, просмотр лога мне не дал абсолютно ничего. Быстро стало ясно, что я читал не тот лог-файл, и действительно, при ближайшем рассмотрении оказалось, что в </span><span style=" font-family:'monospace'; font-size:9pt;">/var/log/circusd</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> было два файла: </span><span style=" font-family:'monospace'; font-size:9pt;">stage-svcname-stderr.log</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> и </span><span style=" font-family:'monospace'; font-size:9pt;">staging-svcname.stderr.log</span><span style=" font-family:'Sans Serif'; font-size:9pt;">. Я тогда воспользовался для автозавершения команды клавишей Tab, и тот файл, который был выбран автоматически, оказался не тем, что был нужен мне.<br /><br />Один из способов понять, какой файл был действительно использован интересующим меня процессом для логирования, заключался в использовании команды </span><span style=" font-family:'monospace'; font-size:9pt;">lsof -l filename</span><span style=" font-family:'Sans Serif'; font-size:9pt;">, которая вывела бы сведения обо всех процессах, имеющих открытые дескрипторы файлов. Оказалось, что ни с одним из работающих процессов не было ассоциировано лог-файла, который я просматривал с помощью команды </span><span style=" font-family:'monospace'; font-size:9pt;">tail</span><span style=" font-family:'Sans Serif'; font-size:9pt;">, что означало, что этот файл можно было безопасно удалить.<br /><br />Просмотр другого файла тут же позволил выяснить, почему процесс давал сбой (при этом </span><span style=" font-family:'monospace'; font-size:9pt;">circus</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> перезапускал его после сбоя, что приводило к бесконечному циклу сбоев-перезапусков).<br /><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; color:#3ac1ef;">Итоги</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Чем чаще я использую команду </span><span style=" font-family:'monospace'; font-size:9pt;">lsof</span><span style=" font-family:'Sans Serif'; font-size:9pt;">, тем больше других инструментов она заменяет и тем больше полезного позволяет мне узнать. Надеюсь, теперь у </span><span style=" font-family:'monospace'; font-size:9pt;">lsof</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> есть шанс принести пользу и вам.</span></p></body></html>