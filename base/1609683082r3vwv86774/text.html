<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="block-bartik-content"></a><span style=" font-size:xx-large; font-weight:600;">п</span><span style=" font-size:xx-large; font-weight:600;">одключение модуля реле esp 8266 Умный дом OPENHAB</span> </p>
<p style="-qt-paragraph-type:empty; margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">https://www.youtube.com/watch?v=1SRYGc4djP0&amp;feature=emb_logo</p>
<p style="-qt-paragraph-type:empty; margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В этом уроке мы научимся прошивать модуль <span style=" font-weight:600;">ESP</span> программой <span style=" font-weight:600;">ESPEasy</span>. Подключим <span style=" font-weight:600;">ESP</span> к <span style=" font-weight:600;">OPENHAB</span> и будем управлять Умным домом. Прошивать модуль ESP можно по воздуху, используя WIFI соединение. <br />Напишем код для управления умным домом с помощью правил OPENHAB. И не важно какой модуль вы используете NODEMCU или ESP8266 программа ESPEasy РАБОТАЕТ С ЛЮБОЙ ПРОГРАММОЙ. Я покажу как в <span style=" font-weight:600;">OPENHAB</span> создавать вещи, <span style=" font-weight:600;">THING</span>, работать с <span style=" font-weight:600;">PAPER UI</span> и <span style=" font-weight:600;">BASIC UI</span>. Управлять реле будем с помощью планшета и телефона, а также через ХАБ панель. Изучим настройки, и возможности OPENHAB и <span style=" font-weight:600;">ESPEasy</span>. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Сегодня мы будем подключать модуль из 2-х реле к плате <span style=" font-weight:600;">ESP8266</span> и прошивать для работы в Умном доме на OPENHAB. <br />Для этого урока я буду использовать вот такой набор деталей.<br />модуль ESP8266 ESP07. Мой выбор пал на него только из-за того, что у меня их много и для 2-х реле я считаю, что очень жирно использовать NodeMCU. Чтобы не мучиться с подключением я использую плату на которой уже запаяны все необходимые резисторы и сделаны выводы под обычный шаг 2,54 мм.<br />Гнездо разъёма под мини usb. Так как питать скорее всего буду от телефонной зарядки.<br />Модуль DC-DC AMS1117 это преобразователь с 5 на 3,3вольта. Так как все модули ESP8266 работают от 3.3 вольта.<br />Сдвоенный модуль реле. Он позволит нам управлять большой нагрузкой и работать с напряжением 220 вольт.  <br />Ну и обычно я ставлю какой-нибудь конденсатор по питанию, который защитит от скачков. Но это не обязательно, но желательно так как модуль ESP хоть и маленький на вид, но бывает очень прожорлив. Поэтому его нельзя питать от 3,3 вольта платы Ардуино. Нужен отдельный блок питания.<br /> Ну и сама плата на которой я всё это соберу. Это самая дешёвая коричневая плата, но для сегодняшнего проекта нам хватит и такой.<br />Как я буду паять я показывать не буду. Вернусь, когда всё спаяю. Не уходите. <br />Ну вот и готово. Надеюсь что за это время вы успели поставить лайк. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Все детали отлично разместились на макетной плате. Можно было бы конечно и покомпактнее сделать, но не суть важно. Я правда пока не отмыл её от флюса. Вот как я торопился к вам. Хейторы конечно сейчас начнут ругаться, что отстой и всё такое. Но мне нравится. Сделано надёжно, контакты хорошие и связь не пропадает. Так что буду дальше показывать на этой плате. <br />Подготовимся к прошивке. Надеюсь, что это все умеют делать. Подключим питание. Я использую обычную зарядку от телефона. И запустим ESP  flasher. Я это делаю от имени администратора. <br /><br />На сегодняшний день самой лучшей программой для прошивки модулей ESP8266 является программа ESPEasy. Удобство этой программы в том, что ESP надо прошить всего 1 раз с компьютера, а всё остальное будет уже происходить по воздуху, через ваше WIFI соединение. А ещё там есть прошивки для всевозможных модулей и датчиков, как для Ардуино, так и других контроллеров и просто заводских изделий. Например, Умные лампы, розетки и многое другое.<br />Надеюсь, что подключать ESP8266 к компьютеру вы уже умеете и я не буду здесь останавливаться. Это я говорю не для обладателей NODEMCU.<br />Я например подключаюсь через Ардуино. Как это сделать можете посмотреть мои предыдущие видео, там я подробно рассказывал об этом.<br />Надеюсь за это время вы успели поставить лайк? <br />Теперь вернёмся к ESPEasy.<br />Для начала скачаем программу для прошивки ESP и не важно какая у вас плата, ESP 01 или NodeMCU.<br />Качать будем с гитхаба. <br />Ищем в поисковике ESPEasy. Самая первая строка это то что нам нужно. Заходим и попадаем на самую свежую прошивку. Прокручиваем вниз и нажимаем скачать  <br />Прошивка весит – 70 мегабайт.<br />После скачивания устанавливаем программу на компьютер и запускаем ESP.Easy.Flasher.exe <br />Вам выпадет вот такое вот окно. Вот с ним мы и будем работать. Все функции программы я сегодня рассказывать не буду. Их очень много, а расскажу только то что нам сегодня понадобится, а про остальное узнаете в процессе следующих уроков.<br />В следующих уроках я буду постоянно ссылаться на это видео. Поэтому я так подробно рассказываю. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">в тексте </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Кодирование.<br />Для написания кода я буду использовать программу Visual Studio Code, но вы можете использовать просто notepad++. Я очень долго писал в нём и это никак не сказывалось на коде. Просто сейчас, когда кода стало очень много я перешёл на студию. Так что решайте сами в чём вам удобнее.<br />Сначала создадим файл items. Этих файлов может быть много. Я например делаю так. Для каждой вещи, я создаю свой items. Это удобно потом для поиска и редактирования.<br />У нас сегодня будут 2 реле, поэтому вставим вот такие строчки.<br />Все примеры вы потом сможете скачать единым архивом с сайта. Ссылка будет в описании.<br />Код состоит из вот такой строки.<br />SWITCH, Служебного названия, Описания которое вы увидите в интерфейсе, и ссылке на канал.<br />Ссылка пока будет пустая. Вы потом вставите сюда код после того как создадите канал.<br />Пока это может быть непонятно, но скоро всё станет ясно.<br /> Второй файл который сегодня понадобится – это файл sitemap.<br />Этот файл может быть только один и он отвечает за вывод в интерфейс BASIC UI.<br />Про него я рассказывал в прошлом уроке. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Запускаем ESP EASY FLASHER. <br />В открывшемся окне мы будем производить настройки для прошивки нашего модуля.<br />Для начала установим порт к которому подключен модуль ESP. Если у вас стоит галочка, то вы увидите только активные порты.<br />Затем выберем прошивку. Как можно увидеть здесь их очень много. Есть прошивки абсолютно для любых версий модуля. Вы также можете просто очистить модуль прошив его прошивкой blank. <br />Единственное, что вам нужно  знать так это объём флэш памяти которое находится на борту вашего модуля. У меня например 1 мегабайт, а если у вас Node MCU, то памяти скорее всего 4 мегабайта. Сегодня я не буду очищать свой модуль, а сразу прошью.<br />Для моделей есть 4 варианта прошивки.<br />Тестовая, нормальная, минимальная и кастомная.<br />Советую прошивать нормальной прошивкой. Так как мой модуль ESP 8266 , то я выбираю вот эту прошивку.<br />Нормальная, для    ESP 8266 объёмом 1 мегабайт.<br />Можно ещё изменить скорость, но думаю не стоит, так как 115200 это оптимальная скорость работы модуля.<br />Дальше надо указать имя под которым вы будете использовать его. Имя нужно выбирать так чтобы потом можно было легко вспомнить что это такое и за что отвечает.<br />в тексте Далее надо указать номер устройства. Номера должны быть уникальными, не повторяющимися. <br />Ну и пароль. Вы конечно можете его не указывать, но тогда кто-нибудь может подключиться к нему. Так что для безопасности пароль нужно указывать всегда.<br /> Ниже идут настройки ваше WIFI сети. Название и пароль. Я их скрыл. Ну мало ли что.<br />Здесь также можно указать фиксированный IP адрес устройства. Если вы его не укажете, то он будет присвоен вашим роутером. <br />Я указал, что он будет 192 168 1 111, и потом буду входить по этому адресу.<br />Ну и последняя строчка – это для резервной WIFI сети. Если модуль не сможет подключиться к одной сети, то он будет искать вторую.<br />Теперь нажимаем прошить и ждём. Ждать придётся примерно 3-5 минут. Так что запаситесь терпением.<br />Во время прошивки на модуле ESP будет мигать светодиод – это показывает, что идёт приём-передача информации. Через какое-то время вы увидите как побегут строчки указывающие что в данный момент происходит. Там будет выводиться информация которую вы указали в полях. Название, номер, пароль. Свойства вашей WIFI сети. Модуль сам перезагрузится и пропингует то адрес что ему был присвоен.<br />После того как  как вы увидите вот такой экран, естественно со своими настройками, то вам надо будет перезагрузить модуль. Желательно отключив его от питания.<br />После этого ваш модуль будет готов для работы через WIFI, и больше вам не надо будет подключать его к компьютеру, а прошивать можно будет и с телефона.<br />Это очень удобно.<br />Следующий этап – это работа модуля с реле. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Настройка модуля реле в программе ESPEasy.<br />Открываем любой браузер и вводим IP адрес вашего устройства. В моём случае  - это 192.168.1.111 <br />Если вы задавали пароль,  чего я вам советую делать всегда, то у вас откроется стандартное окно с полями ввода пароля.<br />Логин всегда будет админ, а пароль, тот, что вы задали. Я в своём примере пароль тоже  сделал админ.<br />Заходим. Перед нами открывается вот такой интерфейс.<br />Сначала рассмотрим вкладку MAIN<br />Мы видим номер вашего устройства. В своём примере я указал, что он будет 5<br />Локальное время – Оно пока у нас не установлено<br />Время работы модуля в сети.<br />Загружено в процентах.<br />Свободно оперативной памяти.<br />IP адрес устройства.<br />И уровень принимаемого сигнала.<br />Если открыть дополнительные свойства, то можно увидеть намного больше информации. <br />Я не буду рассказывать про них, сами посмотрите.<br />Из интересного там, настройки вашей сети и полные сведения о модуле ESP. Размер памяти, <br />скорость, частота и многое другое.<br />Откроем вкладку Config.<br />Вы увидите уже заполненные поля данными что мы указывали при прошивке модуля.<br />Название, номер устройства, админский пароль. Название и пароль  вашей WIFI сети. Здесь мы ничего изменять не будем.<br />Теперь перейдём к вкладке  Controllers<br />ПОКА здесь пусто, но потом мы установим здесь связь с MQTT и нашим OPENHAB и настроим <br />публикацию<br /> в топик Status. <br />Посмотрим что в HARDWARE.<br />Здесь очень много информации, но нам для сегодняшнего урока понадобится только <br />Установка светодиода<br /> на плате ESP. Точнее сделаем так, что при работе с сетью он будет светится, а при потере <br />сети, погаснет. Светодиод находится на GPIO2. Также если вам понадобятся дополнительные<br /> контакты, то вы можете отвязать контакты SDA, SCL от I2C установив их в NONE. <br />Переходим в DEVICE.<br />Здесь мы будем добавлять наши устройства и указывать к каким контактам они <br />присоединены. Так же проводить конфигурацию.<br />В NOTIFICATIONS мы ничего сегодня изменять не будем, а перейдём сразу в TOOLS<br />Здесь можно перезагрузить модуль, прочитать логи, обновить прошивку, но мы <br />сегодня только подключим сервер времени и установим наш часовой пояс и подключим работу с правилами.. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">в тексте </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Теперь давайте выполним настройку нашего модуля и конфигурацию реле. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Заходим в controllers и нажимаем добавить.<br />В выпадающем списке выбираем пункт HOME Assistans, OPENHAB MQTT.<br />Указываем IP на котором у вас размещён MQTT сервер. Если вы при установке не меняли порт, то он указан верно. Дальше надо ввести логин и пароль от MQTT брокера.<br />Включить соединение.<br />Заполним поля<br />LWT Connect Message – это сообщение об установлении соединения. <br />и<br />LWT Disconnect Message - сообщение о потере соединения   </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />А здесь мы указываем, что если связь с WIFI установлена, то включить светодиод, а если связь пропала выключить. Светодиод находится на 2 ножке модуля. Про эти контакты я уже говорил. Больше ничего менять не надо. И главное. Не забывайте постоянно  нажимать SUBMIT.  </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Переходим к device. Нажимаем добавить. В выпадающем списке выбираем <span style=" font-weight:600;">SWITCH INPUT – SWITCH</span>.<br />Указываем имя. Не забываем что оно должно быть уникальным и чтобы вы потом вспомнили что это.<br />У меня это уже 5 реле в системе. Поэтому я так и укажу. Включаем его, а также включаем внутреннюю подтяжку. Указываем к какому GPIO он подключен. В моём случае к GPIO 14. Ставим галочку Отправлять свой статус. Делаем небольшую защиту от дребезга. Ещё здесь можно указать, что срабатывание от двойного клика и или от долгого нажатия на выключатель. И время нажатия. Ставим галку отправлять данные.<br />Тоже самое проделываем со вторым реле. Только имя и GPIO ставим другие.  </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Ну вот и осталась последняя вкладка TOOLS. Здесь мы рассмотрим только Advanced.<br />Для начала устанавливаем галочку, что мы будем использовать правила. Теперь нам нужно указать адрес ntp сервера. Сервера точного времени. В ы можете выбрать свой или указать тот что у меня. Но всё равно посмотрите как найти сервер. В любом поисковике набираете ntp сервер и открываете страницу. Затем выбирает не самый загруженный сервер. Копируете его имя и вставляете в свои настройки.<br />А здесь устанавливаете, что неделя у нас начинается с понедельника, а не с воскресенья. Как у них там.<br />Теперь надо указать свою часовую зону, или часовой пояс. Указывается в минутах. Мой часовой пояс + 3. Это значит 180 минут. Вот их я и вставлю.<br />Теперь установим широту и долготу своего родного города. Это не обязательно, но может потом пригодиться, например для датчика давления. Там будет нужно знать высоту над уровнем море. Ну может ещё где пригодится.<br />Делается это также просто. В поисковике набираете широта и долгота и вставляете эти данные в настройки.<br />Больше ничего менять не будем, хотя здесь есть ещё пару значений которые можно поменять. Но сегодня они нам не понадобятся.<br />На этом мы настройку закончили. Идём снова в MAIN и смотрим, что у нас изменилось.<br />Мы видим, что у нас установилось локальное время, и что мы находимся в сети уже 14 минут. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Повторяться не буду. Расскажу только про новое.<br />Frame отвечает, что на экране будет показана кнопка с описание ВКЛЮЧЕНИЕ РЕЛЕ, а сами реле будут показаны только после нажатия на эту кнопки.<br /><br />Внутренний frame покажет сами реле.<br /><br />Здесь показано, что<br />Это SWITCH и он связан с каналом и рядом будет выведена иконка. Позже я покажу как менять иконки.<br />На этом весь коддинг закончен. Теперь переходим к созданию в OPENHUB.<br />Заходим в PAPER UI, в INBOX. Нажимаем +. Выбираем MQTT Binding и жмём Добавить в ручную.<br />Здесь выбираем GENERIC MQTT Thing и создаём новую Вещь. Я буду часто говорить слово вещь, так как THING переводится как вещь. К этому просто надо привыкнуть.<br />Называем вещь. Название должно состоять из имени что вы назвали ваш ESP когда прошивали его прошивкой ESPEasy и номера который тоже там указали. <br />При прошивке я неточно выразился сказав, что номер должен быть уникальным. Точнее будет сказать что связка НАЗВАНИЕ-НОМЕР должна быть уникальна.<br />Например у вас 5 реле. И все они названы реле. И отличить их можно только по номеру. Надеюсь что объяснил.<br />Я скопировал это название, чтобы не ошибиться при написании его в дальнейшем.<br />Теперь связываем эту вещь с москито брокером.<br />Сохраняем. Теперь выбираем её из списка и создаём каналы.<br />Для начала нам надо выбрать тип канала. Их много, но нам нужен on off Switch. Теперь прописываем его ID<br />Оно состоит из название вещи и дополнительной цифры. Для первого реле я указал цифру 1.<br />Теперь пишем статус топика для этого канала и команду для него которая состоит из имени ESP и номера вывода к которому присоединено реле. У меня это 12 ножка для первого реле и 14 для второго. <br />Теперь пишем значения которые будут отправлены подписчикам топика. При включённом реле это 0, а при выключенном 1. Сохраняем и по аналогии создаём канал для второго реле. Только с постфиксом 2 и gpio 14.<br />Мы видим, что у нас теперь созданы 2 канала. Теперь надо скопировать адрес топика MQTT брокера и вставить его в файле items.<br />Вот и всё. Видите как мало всего потребовалось чтобы в OPENHAB создать и вывести в интерфейс наше устройство. Заняло всего минут 5.<br />Это 1 FRAME в коде файла Items, а это второй.<br />Теперь понажимаем кнопки. Реле должно весело щёлкать. Всё должно работать.<br />Теперь давайте поменяем иконки. Это сделать совсем не сложно. В openhab есть набор иконок которые вы можете вставить в сой код простым копирование названия. Но вы можете вставлять и другие картинки. Для этого их надо скачать и положить в папку ICONS.<br />Изменим иконку на розетку. Видим, что она изменилась. В галереи иконок есть и такие которые содержат 2 состояния. С ними получается очень интересный эффект. В рабочем состоянии один вид, а в не рабочем другой.<br />Теперь поуправляем с планшета и с телефона. Кстати для телефонов есть отдельное приложение для OPENHAB. Про него я расскажу в следующих уроках.<br />Переключения происходят практически без задержек. Изменения на планшете и телефоне синхронны и тоже без отставаний.<br />Вывод на хаб панель я сегодня не делал. И так урок получился очень длинным. Это мой первый такой продолжительный урок. Если количество досмотров будет большое, то я продолжу снимать такие подробные уроки. Если нет, то ограничусь только коддингом и короткой информацией. Не хотелось бы снимать впустую.<br />На этом я заканчиваю урок. И как говорил, когда будет следующий зависит только от вас.<br />До встречи.<span style=" color:#000000;"> </span></p></body></html>