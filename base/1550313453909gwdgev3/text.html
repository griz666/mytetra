<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://podarok66.livejournal.com/7825.html"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; text-decoration: underline; color:#0000ff;">Скрипт, заменяющий Wachdog</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;"> </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">18 июл, 2013 в 21:22 </li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">В течение некоторого времени я пытался использовать штатную утилиту Wachdog. Данная утилита пингует указанный при настройке IP-адрес и при отсутствии ответа выполняет перезагрузку роутера. Но далеко не всё в работе данной утилиты меня устраивало. Пинг лишь одного адреса, малая гибкость в настройках заставили меня искать другое решение. Большую часть кода подсказала статья на </span><a href="http://habrahabr.ru/post/141785/"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">Хабрхабре</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;"> (автору спасибо), добавлять пришлось лишь пару команд.<br /></span><a name="cutid1"></a><span style=" font-family:'Sans Serif'; font-size:9pt;">И</span><span style=" font-family:'Sans Serif'; font-size:9pt;">так создаю скрипт </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Ping_con</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> :<br /></span><a href="https://www.livejournal.com/rsearch/?tags=%23Задаём"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">#Задаём</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;"> переменную, определяющую количество запросов на каждый адрес<br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">:local PingCount 3</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br /></span><a href="https://www.livejournal.com/rsearch/?tags=%23Задаём"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">#Задаём</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;"> локальные переменные - IP адреса для пинга. У меня второй адрес - внутренний адрес сервера провайдера.<br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">:local Google 8.8.8.8<br />:local Iphome 10.201.10.1<br />:local mail  94.100.180.201</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br /></span><a href="https://www.livejournal.com/rsearch/?tags=%23Локальные"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">#Локальные</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;"> переменные, содержащие количество удачных ответов на пинги. Интерфейс ether2 - у меня смотрит в интернет.<br />:local ResultGoogle [/ping count=$PingCount $Google interface=ether2]<br />:local ResultIphome [/ping count=$PingCount $Iphome interface=ether2]<br />:local ResultMail [/ping count=$PingCount $mail interface=ether2]<br /><br /></span><a href="https://www.livejournal.com/rsearch/?tags=%23Самое"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">#Самое</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;"> вкусное. Переменная MainIfInetOk - есть ложное утверждение. Далее изменяем его, подставляя сравнение.<br /></span><a href="https://www.livejournal.com/rsearch/?tags=%23Сумма"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">#Сумма</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;"> полученных удачных ответов должна быть не меньше 2/3 от общего числа запросов.<br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">:local MainIfInetOk false;<br />:set MainIfInetOk (($ResultGoogle + $ResultIphome + $ResultMail) &gt;= (2 * $PingCount))<br />:put &quot;MainIfInetOk=$MainIfInetOk&quot;</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br /></span><a href="https://www.livejournal.com/rsearch/?tags=%23Теперь"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">#Теперь</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;"> делаем выводы на основании полученных вычислений.<br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">if (!$MainIfInetOk) do={<br />/log error &quot;Bad connect&quot;<br />/system reboot<br />}<br />if ($MainIfInetOk) do={<br />/log info &quot;Connect OK&quot;<br />}</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br /><br />В шедулере создаю две новых записи.<br />Первая </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Ping</span><span style=" font-family:'Sans Serif'; font-size:9pt;">:<br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">/system script run Ping_con</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br /><br />Исполнение каждые 5 минут, начало исполнения </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">startup</span><span style=" font-family:'Sans Serif'; font-size:9pt;">, состояние в начале тестирования </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">disable</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Вторая </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Time</span><span style=" font-family:'Sans Serif'; font-size:9pt;">:<br /><br />:delay 100;<br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">/system scheduler disable Ping</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">:delay 3500;</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">/system scheduler enable Ping</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />Исполнение по нулям, пусть запускается единожды, начало исполнения </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">startup</span><span style=" font-family:'Sans Serif'; font-size:9pt;">, состояние в начале тестирования </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">enable</span><span style=" font-family:'Sans Serif'; font-size:9pt;">.<br /><br />После перезагрузки запускается </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Time</span><span style=" font-family:'Sans Serif'; font-size:9pt;">, который ждет один час, потом запускает шедулер </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Ping</span><span style=" font-family:'Sans Serif'; font-size:9pt;">, запускающий скрипт </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Ping_con. </span><span style=" font-family:'Sans Serif'; font-size:9pt;">Теперь проверка будет выполнятся каждые 5 минут. Если интернет пропадет, скрипт даст команду на перезагрузку. После перезагрузки начнет отрабатывать шедулер </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Time</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> и цикл повторится. На время тестирования в скрипте </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Ping_con</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> строку </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">/system reboot </span><span style=" font-family:'Sans Serif'; font-size:9pt;">можно закоментировать, ориентируясь в работе скрипта по логу. После наладки можно закоментировать строку </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">/log info &quot;Connect OK&quot;,</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> а строку</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> /system reboot </span><span style=" font-family:'Sans Serif'; font-size:9pt;">раскоментировать.<br /><br /><br />Такой подход позволяет перезагрузить устройство при обрыве связи с внешним миром в течение 5 минут, но не дергать его перезагрузкой каждые 5 минут, если провайдер временно отключил соединение с сетью.</span></p></body></html>