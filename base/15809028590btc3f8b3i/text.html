<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Mikrotik, DHCP Classless Route </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habr.com/ru/hub/sys_admin/"><span style=" text-decoration: underline; color:#0000ff;">Системное администрирование</span></a>, </li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habr.com/ru/hub/network_technologies/"><span style=" text-decoration: underline; color:#0000ff;">Сетевые технологии</span></a> </li></ul>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Tutorial </li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post-content-body"></a><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">D</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">HCP Classless Route</span><span style=" font-family:'Sans Serif'; font-size:9pt;">, зачем он нужен?<br /><br />У нас в компании для VPN используется решение на </span><a href="http://www.tinc-vpn.org/"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">tincd</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;">. Из-за того, что на Mikrotik я не нашёл простого способа запустить tinc, было решено запускать VPN на отдельном сервере и использовать его как шлюз. Первая попытка — прописать маршрут на маршрутизаторе. По пингам было видно, что маршрутизатор присылает сообщение о редиректе, при этом наблюдались сетевые лаги. При работе создавалось ощущение, что соединение, установленные таким образом, подтормаживает. <br /><br />В качестве эксперимента решил попробовать на своём рабочем месте прописать маршрут руками. Это оказалось правильным решением — лаги пропали, но данную операцию нужно было проделать на всех машинах офиса, а руками вбивать как то не хотелось. В связи с этим понадобился способ, без особого напряжения, настраивать статический маршрут, на всех клиентах, получающих адрес по DHCP протоколу. <br /><br />Процесс гугления привёл меня на </span><a href="http://wiki.mikrotik.com/wiki/Manual:IP/DHCP_Server#DHCP_Options"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">страницу документации</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;"> Mikrotika. Всё ясно — нам поможет </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">DHCP Classless Route</span><span style=" font-family:'Sans Serif'; font-size:9pt;">. Настройка относительно легка, но вот из-за этой относительности убил на настройку пол дня. При этом возникали проблемы с сетевым доступом у хостов сети — у Windows машин пропадал маршрут по умолчанию. <br />Ещё одна сложность настройки Mikrotik заключается в том, что нужно вводить маршрут в шестнадцатеричном (либо в двоичном) виде, что меня слегка сбило с толку. Да и в документации некоторые нюансы не указаны. Данная опция рассмотрена в базовом варианте. А дальше как хотите )). Пришлось немного углубиться в подробности настройки.<br /></span><a name="habracut"></a><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt;">Для того что бы у вас маршрут получили все хосты, независимо от семейства операционной системы нужно настроить 2 опции </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">121</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> и </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">249</span><span style=" font-family:'Sans Serif'; font-size:9pt;">. Если бы все разработчики следовали бы RFC, то возможно жизнь системных администраторов была бы гораздо преснее и менее интересной. <br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:4px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Опция 121</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Опция </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">121</span><span style=" font-family:'Sans Serif'; font-size:9pt;">, как и все остальные DHCP опции, описана в </span><a href="https://tools.ietf.org/html/rfc3442"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">rfc3442</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;">. Этот документ диктует следующие правила и требования к 121 параметру: <br /></span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">минимальная длина 5 байт. </li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">можно вписать один или более маршрутов</li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">каждый из маршрутов должен содержать Адрес сети назначения и IP адрес шлюза.</li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Согласно этого же документа схема маршрута будет выглядеть так:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Code Len Destination 1 Router 1<br />+-----+---+----+-----+----+----+----+----+----+<br />| 121 | n | d1 |… | dN | r1 | r2 | r3 | r4 |<br />+-----+---+----+-----+----+----+----+----+----+<br /><br />Destination 2 Router 2<br />+----+-----+----+----+----+----+----+<br />| d1 |… | dN | r1 | r2 | r3 | r4 |<br />+----+-----+----+----+----+----+----+<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />Для того что бы правильно составить маршрут нужно перевести адрес сети назначения, маску подсети и адрес шлюза в шестнадцатеричный формат. Желающие </span><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: line-through;">пострадать</span><span style=" font-family:'Sans Serif'; font-size:9pt;">повысить личный скилл могут переводить в двоичный формат.<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Пример 1.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Составим строку маршрута для сети 10.0.0.0/</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">24</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> через маршрутизатор 192.168.0.2<br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">LEN</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> (маска подсети назначения) = 24 = </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">0x18</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">DESTINATION</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> = 10.0.0.0 = </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">0A 00 00</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> <br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">ROUTER</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> = 192.168.0.2 = </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">c0 a8 00 02</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Итоговая строчка: </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">0x180A0000c0a80002</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />добавляем маршрут в микротик:<br />через winbox<br /></span><img src="image1580902809x3bpfv0lzi.png" /><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />через консоль<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">/ip dhcp-server option<br />add code=121 name=opt_121_10 value=0x180A0000c0a80002<br />set 0 dhcp-option=opt_121_10<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Пример 2.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Составим строку маршрута для сети 10.0.0.0/</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">8</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> через маршрутизатор 192.168.0.2<br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">LEN</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> (маска подсети назначения) = 8 = </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">0x08</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">DESTINATION</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> = 10.0.0.0 = </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">0A</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> <br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">ROUTER</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> = 192.168.0.2 = </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">c0 a8 00 02</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Итоговая строчка: </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">0x080Ac0a80002</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Пример 3.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Составим строку маршрута для сети 10.0.0.0/</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">8</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> через маршрутизатор 192.168.0.2<br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">LEN</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> (маска подсети назначения) = 29 = </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">0x19</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">DESTINATION</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> = 172.16.4.0 = </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">AC100400</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> <br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">ROUTER</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> = 192.168.0.2 = </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">AC10040001</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Итоговая строчка: </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">0x19AC100400AC10040001</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Картинки ко 2 им 3 примерам не прикладываю, т.к. на самом маршрутизаторе настраивать идентично примеру 1. <br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Очень легко можем нарваться на внезапное отключение клиентов из-за одного маленького нюанса</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Если вы некорректно укажете адрес подсети. Ошибку сделать очень легко. Что бы избежать этого нужно вспомнить теорию и применить её на практике.<br /><br />Давайте вспомним. Есть адрес и маска подсети. Адрес делят на две части — сетевую и хостовую. <br />Маска подсети указывает сколько первых бит адреса относится к сетевой части. Соответственно, оставшаяся часть адреса, указывает на хостовую. <br />Если нам нужен маршруте к сети с маской 24 бита, то нам нужны первые 3 октета адреса </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">сети</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> назначения (Пример 1)<br />Если нам нужен маршруте к сети с маской 8 бит, то нам нужен, всего лишь, 1-й октет адреса </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">сети</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> назначения (Пример 2) <br />Если нам нужен маршруте к сети с маской 25 бит, то тут нужно будет указывать все октеты (Пример 3)<br /><br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:4px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Опция 249</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">На </span><a href="https://ru.wikipedia.org/wiki/DHCP"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">страничке wikipedia</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;"> с описанием dhcp есть </span><a href="http://www.networksorcery.com/enp/protocol/bootp/options.htm"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">ссылка</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;"> на общепринятые DHCP опции. 249 опция находится в диапазоне для частного использования. <br />Я не знаю почему товарищи мелгкомягкие придерживаются </span><a href="https://ru.wikipedia.org/wiki/%D0%9B%D0%B5%D0%BD%D0%B8%D0%BD%D1%81%D0%BA%D0%B8%D0%B5_%D1%84%D1%80%D0%B0%D0%B7%D1%8B#.C2.AB.D0.9C.D1.8B_.D0.BF.D0.BE.D0.B9.D0.B4.D1.91.D0.BC_.D0.B4.D1.80.D1.83.D0.B3.D0.B8.D0.BC_.D0.BF.D1.83.D1.82.D1.91.D0.BC.C2.BB"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">взглядов товарища Ленина</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;">, но им они следуют достаточно фанатично. Несмотря на наличие RFC3442 майкрософт решил на своих клиентах маршрут получать опцией 249. <br />На микротике данная опция настраивается подобно 121-й опции<br />0x[</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">маска подсети адреса назначения</span><span style=" font-family:'Sans Serif'; font-size:9pt;">][</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">адрес назначения</span><span style=" font-family:'Sans Serif'; font-size:9pt;">][</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">адрес шлюза</span><span style=" font-family:'Sans Serif'; font-size:9pt;">]<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Если возникнут проблемы с настройкой Windows машин, то попробуйте воспользоваться советом под спойлером</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:4px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Несколько маршрутов одной строкой</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />К сожалению в документации на сайте Mikrotik нет примера как правильно настраивать несколько маршрутов. На помощь нам приходит RFC3442 в котором есть замечательная схема составления нескольких маршрутов которая приведена выше. <br />Добавляем к первому маршруту второй маршрут без 0x<br />Пример<br />два маршрута 10.0.0.0/8 и 172.16.4.0/24 через шлюз 192.168.0.2 одной строкой будут выглядеть так:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">0x</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">08</span><span style=" font-family:'Sans Serif'; font-size:9pt;">0Ac0a80002</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">18</span><span style=" font-family:'Sans Serif'; font-size:9pt;">AC100Bc0a80002</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">жирным выделил маски подсетей<br /><br />Надеюсь что данная информация будет кому то полезной.<br /><br />PS: Прошу замечания и предложения направлять в личку.<br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">UPD:</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />товарищ </span><a href="https://habrahabr.ru/users/orlovdl/"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">orlovdl</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;"> </span><a href="https://gist.github.com/mosquito/b947c442241ad44224cc"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">набросал python функцию</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;"> для перевода блока адресов в Hex формат. <br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">UPD: </span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />товарищ </span><a href="https://habrahabr.ru/users/poofeg/"><span style=" font-family:'Sans Serif'; font-size:9pt; text-decoration: underline; color:#0000ff;">poofeg</span></a><span style=" font-family:'Sans Serif'; font-size:9pt;"> подсказал:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Я бы обратил внимание на эту фразу в RFC3442:<br />DHCP server administrators [...] should specify the default router(s) both in the Router option and in the Classless Static Routes option.<br />Во всех ваших примерах в опции 121 маршрут по умолчанию отсутствует. То есть к обоим строчкам лучше в конце дописать 00c0a80001 (0.0.0.0/0 via 192.168.0.1). </span></p></body></html>