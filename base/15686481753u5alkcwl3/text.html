<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:xx-large; font-weight:600;">iptables и динамические правила (keep state)</span> </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://skeletor.org.ua/?p=1719#respond"><span style=" text-decoration: underline; color:#0000ff;">Добавить комментарий</span></a> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Такого понятия как динамические правила в <span style=" font-weight:600;">iptables</span> не существует. Правильно называть — отслеживание состояния <span style=" font-weight:600;">keep state</span>.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В <span style=" font-weight:600;">Iptables</span> существуют такие типа состояния (доступно, если модуль ‘<span style=" font-weight:600;">state</span>‘ загружен с помощью ‘<span style=" font-weight:600;">-m state</span>‘):</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#ff6600;">NEW</span> — Все пакеты устанавливающие новое соединение (Например, запрос на установление соединения)</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#ff6600;">ESTABLISHED</span> — Все пакеты принадлежащие установленному соединению (Например, <span style=" font-weight:600;">GET</span> ответ <span style=" font-weight:600;">web</span>-сервера)</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#ff6600;">RELATED</span> — Пакеты, не принадлежащие установленному соединению (то есть те пакеты, которые являются частью новых соединений, которые было инициированы уже установленным <span style=" font-weight:600;">ESTABLISHED</span> соединением), но связанные с ним. (Например — <span style=" font-weight:600;">FTP</span> в активном режиме использует разные соединения для передачи данных. Эти соединения связанны.)</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#ff6600;">INVALID</span> — Пакеты, которые не могут быть по тем или иным причинам идентифицированны. Например <span style=" font-weight:600;">ICMP</span> ошибки не принадлежащие существующим соединениям</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Теперь перейдём к созданию правил. Первым делом изменим политики по умолчанию:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">iptables -P INPUT DROP<br />iptables -P OUTPUT DROP</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Нужно ещё не забыть разрешить трафик по петлевому интерфейсу (что бы сервер сас с собой мог общаться по адресу <span style=" font-weight:600;">127.0.0.1</span>):</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">iptables -A INPUT -i lo -j ACCEPT<br />iptables -A OUTPUT -o lo -j ACCEPT</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">И напоследок — правил отслеживающие состояние:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT<br />iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Этим мы создали полностью закрытый файервол. Теперь осталось добавлять разрешающие правила. Вот несколько примеров:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic; color:#ff6600;">— разрешаем только исходящие пинги</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">iptables -A INPUT -p icmp --icmp-type echo-reply -j ACCEPT<br />iptables -A OUTPUT -p icmp --icmp-type echo-request -j ACCEPT</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic; color:#ff6600;">— разрешаем доступ к серверу по ssh:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">iptables -A INPUT -p tcp -m state --state NEW --dport 22 -j ACCEPT</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">А вот полный листинг нашего файервола:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">iptables -F<br />iptables -P INPUT DROP<br />iptables -P OUTPUT DROP<br />iptables -A INPUT -i lo -j ACCEPT<br />iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT<br />iptables -A INPUT -p icmp --icmp-type echo-reply -j ACCEPT<br />iptables -A INPUT -p tcp -m state --state NEW --dport 22 -j ACCEPT<br />iptables -A OUTPUT -o lo -j ACCEPT<br />iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT<br />iptables -A OUTPUT -p icmp --icmp-type echo-request -j ACCEPT</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; font-style:italic; color:#ff6600;">Ложка дёгтя.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Дело в том, что при таких правилах файервол не разъединяет <span style=" font-weight:600;">ESTABLISHED</span> соединения. Если вы хотите принудительно это сделать — лучший вариант:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">iptables -I INPUT 1 -s 10.10.10.10 -m state --state ESTABLISHED,RELATED -j DROP</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">где <span style=" font-weight:600;">10.10.10.10</span> — адрес, который установил соединение.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; font-style:italic; color:#ff6600;">Примечание.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если вы используете цепочку <span style=" font-weight:600;">FORWARD</span>, то для неё будут нужны такие правила:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">iptables -P FORWARD DROP<br />iptables -A FORWARD -i $INET_IFACE -m state --state ESTABLISHED,RELATED -j ACCEPT<br />iptables -A FORWARD -i $LAN_IFACE -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT</span></p></body></html>