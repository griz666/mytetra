<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:xx-large; font-weight:600;">Подводные камни настройки Mikrotik SXT LTE</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Sans Serif'; font-size:9pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Доброго времени суток Хабр, попытаюсь рассказать о своём знакомстве с такой вещью, как Mikrotik SXT LTE, муках настройки и последующего доведения до ума.<br /><br /></span></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1565810645ft5sheejq0.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Немного предыстории:</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />Своё знакомство с Mikrotik и RouterOS начал около двух лет назад, имеется сертификат MTCNA, планирую в ближайшее время получить MTCRE и MTCWE. За это время я не устаю восхищаться оборудованием Mikrotik за их функциональность. В основном работал с представителями линейки RouterBoard 7xx и 9xx, так как их возможностей и мощностей всегда хватало, до недавних пор. <br /></span><a name="habracut"></a><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt;">Недавно появился следующий объект — нефтебаза с довольно развитой сетевой инфраструктурой: локальный домен, АТС (Asterisk FreePBX), соответственно SIP-телефония, Wifi-мосты, куча сетевых видеорегистраторов и специализированное оборудование автоматики, управлял этим всем Zyxel ZyWALL USG 20. Узким местом этого всего было отсутствие проводного интернета, доступ к нему осуществлялся посредством LTE, через худо-бедно работающий Zyxel LTE6100. Периодическое «отвалы» lte для него было нормой, иногда только ребут помогал восстановить связь, радости не добавлял так же «деревянный» и слабо-отзывчивый интерфейс Zyxel'я.<br /><br />В итоге, через некоторое время и довольно большое количество накопившихся жалоб было решено искать альтернативу. Взгляд сразу упал на Mikrotik SXT LTE потому что:<br /><br />— 2 в 1, заменял собой сразу 2 железки — роутер и lte-модем;<br />— RouterOS и её богатые возможности по реализации различных хотелок;<br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Выбор прошивки:</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />Прибывшая железка несла в себе RoS версии 6.36.2, по привычке я сразу обновил её до свежей, на тот момент, current 6.40. Это была моя первая ошибка, усложнившая мне задачу, уже на месте в «полевых» условиях. Я не проверил работоспособность LTE на рабочим месте в комфортных условиях, так элементарно под рукой не оказалось SIM-карты с поддержкой LTE. В результате, уже на объекте, меня ждало удивление, когда SXT ни в какую не хотела видеть сигнал с базовой станции, что на «дефолтной», что на пустой конфигурации. Пришлось спешно откатываться на «коробочную» версию RoS, качая её через мобильный интернет. Тогда же пришло осознание того, что пакет lte не входит в Main package — набор RoS и помимо его необходимо загрузить Extra packages.<br /><br />Загружаем routeros-mipsbe-x.xx и lte-х.хх-mipsbe в память микротика (вкладка Files в меню winbox'а): <br /><br /></span></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1565810645in1myo9f0e.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Далее System — Packages и нажимаем Downgrade. Микротик попросит разрешение на перезагрузку для отката на более старую версию RoS, нажимаем Yes.<br /><br /></span></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1565810645xr1rn4ht1z.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />После отката не стал сбрасывать сразу настройки в 0, а предпочел проверить на дефолтной. Убедившись, что lte-интерфейс поднялся и подключился к базовой станции, можно вернуться к пустой конфигурации и продолжить настройку. <br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Стоит сделать ремарку, что на данный момент SXT LTE работает на последней версии RoS 6.40.1, к которой я пришел постепенно, обновляя на последующие версии, начиная с 6.36 и тестируя стабильность, находясь непосредственно на объекте. <br /><br />При выбору конфигурации, я всегда выбираю пустую — она позволяет настроить все необходимые параметры самостоятельно, в отличие от дефолтной, которая не всегда гарантирует работоспособность устройства по назначению, а иногда может приводить к определённым проблемам.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Настройка LTE-интерфейса:</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />Для начало нам необходимо определиться с частотой LTE frequency band, у каждого оператора она своя, у Yota это band 7.<br /><br />Далее пишем в терминале:<br /><br /></span><span style=" font-family:'monospace'; font-size:9pt;">/interface lte set lte1 band=7 network-mode=lte add-default-route=yes use-peer-dns=yes</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />где:<br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">lte1</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> — имя вашего lte интерфейса<br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">band</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> — frequency band<br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">network-mode</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> — режим работы<br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">add-default-route</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> — добавляем дефолтный маршрут для роутинга<br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">use-peer-dns</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> — используем DNS-сервер оператора<br /><br />В лучшем случае все настройки Mikrotik подцепляет автоматически, но мне пришлось настраивать вручную.<br /><br />В практике настройки серии Routeroard для получения IP-адреса от провайдера необходимо настроить Mikrotik, как DHCP клиента:<br /><br /></span><span style=" font-family:'monospace'; font-size:9pt;">/ip dhcp-client add interface=имя_gateway_интерфейса</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />Но при работе с SXT LTE, Mikrotik получил IP-адрес и DNS от провайдера автоматически, без дополнительных манипуляций.<br /><br />Далее проверяем статус LTE:<br /><br /></span></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1565810645qgtv9qpnaf.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />наличие на LTE-интерфейсе IP от оператора во вкладке IP — Adresses:<br /><br /></span></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image156581064538j4vxsks8.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />и наконец наличие дефолтного маршрута:<br /><br /></span></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1565810645epggx3kucl.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Если его нет, добавляем вручную:<br /><br /></span><span style=" font-family:'monospace'; font-size:9pt;">/ip route add dst-address=0.0.0.0/0 gateway=lte distance=1 </span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />Всё что остаётся, это дать пользователям доступ в интернет:<br /><br /></span><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall nat add chain=srcnat action=masquerade out-interface=lte1</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />На этом базовая настройка Mikrotik SXT LTE закончена, далее пойдут специфические задачи и проблемы, которые мне приходилось решать по необходимости и факту возникновения.<br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Больше одной подсети:</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />Так сетевая инфраструктура на объекте достаточно развита, у неё было 3 подсети для различных назначений:<br /><br /></span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">wifi-мосты и прочее сетевое оборудование;</li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">подсеть SIP-телефонии;</li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">подсеть пользовательских ПК.</li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Т.к. SXT LTE имеет только один ethernet-интерфейс я достаточно долго думал, как осуществлять маршрутизацию между подсетями, даже смотрел в сторону VLAN'ов. Всё оказалось просто, достаточно присвоить интерфейсу несколько ip-адресов, которые являются шлюзом у устройств подсетей:<br /><br /></span><span style=" font-family:'monospace'; font-size:9pt;">/ip address <br />add address=10.254.254.1/24 network=10.254.254.0 interface=ether1-main-pool <br />add address=192.168.21.1/24 network=192.168.21.0 interface=ether1-main-pool<br />add address=192.168.1.1/24 network=192.168.1.0 interface=ether1-main-pool</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">DNS Flood:</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />SXT LTE имеет достаточно слабый ЦП, о чём мне напомнили буквально на следующий день после установки. Сотрудники жаловались на плохую работу сети, а я в свою очередь никак не мог подключиться удаленно на Mikrotik, хотя winbox не дропал меня сразу, а пытался залогиниться. Приехав на место, обнаружил загруженность CPU процессора под 100%. С помощью встроенной в RoS утилитки Tools — Profile обнаружил, что процессор загружен обработкой DNS-запросов. И осознал ещё одну свою ошибку, забыв отключить обработку DNS запросов с внешки.<br /><br /></span><span style=" font-family:'monospace'; font-size:9pt;">/ip dns set allow-remote-requests=no</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />или с помощью firewall'а:<br /></span><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall raw<br />add action=add-src-to-address-list address-list=&quot;dns flood&quot; address-list-timeout=1d chain=\prerouting dst-port=53 in-interface=lte1 protocol=udp<br />/ip firewall filter<br />add action=drop chain=input dst-port=53 in-interface=lte1 protocol=udp src-address-list=&quot;dns flood&quot;<br />add action=drop chain=input connection-state=new dst-port=53 in-interface=lte1 protocol=udp<br />add action=drop chain=input connection-state=new dst-port=53 in-interface=lte1 protocol=tcp</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">CPU Overloaded:</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />Mikrotik никак не фиксирует высокую нагрузку на процессор, поэтому чтобы в будущем контролировать высокую загрузку CPU и решать её, мне помог встроенный язык для написания скриптов:<br /><br /></span><span style=" font-family:'monospace'; font-size:9pt;">:global cpu1 [/system resource get cpu-load];<br /><br />if (($cpu1) &gt;= 90) do={:log warning &quot;CPU load = $cpu1 %&quot;} else={}</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />Выглядит примерно так:<br /><br /></span></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1565810645a2hjeq93tz.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Для удобства все логи отправляются в syslog, чтобы не заполнять flash-память Mikrotik'а и не потерять их при ребуте.<br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">LED индикатор</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />При установке пустой конфигурации, сбрасываются и настройки LED-индикаторов LTE-интерфейса, восстанавливаются при помощи следующих команд:<br /><br /></span><span style=" font-family:'monospace'; font-size:9pt;">/system leds<br />add leds=led1 type=modem-signal interface=lte1 modem-signal-treshold=-91<br />add leds=led2 type=modem-signal interface=lte1 modem-signal-treshold=-81<br />add leds=led3 type=modem-signal interface=lte1 modem-signal-treshold=-71<br />add leds=led4 type=modem-signal interface=lte1 modem-signal-treshold=-61<br />add leds=led5 type=modem-signal interface=lte1 modem-signal-treshold=-51</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Дроп LTE-интерфейса:</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />К сожалению одна из нерешённых проблем SXT LTE, вызванной высокой нагрузкой UDP-трафика, о которой разработчики упомянули на форуме:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;">Yes, it looks like the specific issue sometimes happens on this particular product, we are looking into it. It looks like other LTE modems and wAP LTE does not have this issue. The problem on SXT LTE takes place under heavy UDP traffic, but we are still investigating.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Пару раз ловил исчезновение lte-интерфейса, соответственно отсутствие интернета на объекте. Но по истечении пары минут интерфейс появлялся снова, так что простои были не критичны. Пока жду новую версию RouterOS, которая исправит эту проблему.<br /><br />Вот с чем мне пришлось столкнуться, внедряя специфичную, для меня, «железку», а заодно и почерпнуть кое-что новое. Но этим Mikrotik и хорош, что предоставляет инструменты для решения появившихся проблем.</span></p></body></html>