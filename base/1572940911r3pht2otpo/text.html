<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Мультиван и маршрутизация на Mikrotik RouterOS </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habr.com/ru/hub/sys_admin/"><span style=" text-decoration: underline; color:#0000ff;">Системное администрирование</span></a>, </li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habr.com/ru/hub/network_technologies/"><span style=" text-decoration: underline; color:#0000ff;">Сетевые технологии</span></a>, </li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habr.com/ru/hub/network_hardware/"><span style=" text-decoration: underline; color:#0000ff;">Сетевое оборудование</span></a> </li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post-content-body"></a><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">В</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">ведение </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Взяться за статью, помимо тщеславия, побудила удручающая частота возникновения вопросов по этой теме в профильных группах русскоязычного телеграмм-сообщества. Статья ориентирована на начинающих администраторов Mikrotik RouterOS (далее ROS). В ней рассматривается только мультиван, с акцентом на маршрутизацию. Бонусом присутствуют минимально достаточные настройки для обеспечения безопасной и удобной работы. Те, кто ищет раскрытия тем очередей, балансировки нагрузки, вланов, бриджей, многоступенчатого глубокого анализа состояния канала и тому подобного — могут не тратить времени и сил на прочтение.<br /></span><a name="habracut"></a><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Исходные данные</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />В качестве подопытного, выбран пятипортовый маршрутизатор Mikrotik с ROS версии 6.45.3. Он будет маршрутизировать трафик между двумя локальными сетями (LAN1 и LAN2) и тремя провайдерами (ISP1, ISP2, ISP3). Канал к ISP1 имеет статический “серый” адрес, ISP2 — “белый”, получаемый по DHCP, ISP3 — “белый” с PPPoE авторизацией. Схема подключения представлена на рисунке:<br /><br /></span><img src="image1572940879kduwgruykr.png" /><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />Задача настроить роутер “МТК” на основе схемы так, чтобы:<br /><br /></span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обеспечить автоматическое переключение на резервного провайдера. Основной провайдер — ISP2, первый резерв — ISP1, второй резерв — ISP3.</li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Организовать выход сети LAN1 в Интернет только через ISP1.</li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Предусмотреть возможность маршрутизировать трафик с локальных сетей в Интернет через выбранного провайдера на основе address-list.</li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Предусмотреть возможность публикации сервисов из локальной сети в Интернет (DSTNAT)</li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Настроить фильтр файерволла для обеспечения минимально достаточной безопасности со стороны Интернет.</li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Роутер мог выпускать собственный трафик через любого из трех провайдеров в зависимости от выбранного адреса источника.</li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обеспечить маршрутизацию ответных пакетов в канал, с которого они пришли (включая LAN).</li></ol>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание.</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> Настраивать роутер будем “с чистого листа”, дабы гарантировать отсутствие сюрпризов в меняющихся от версии к версии стартовых конфигурациях “из коробки”. В качестве инструмента настройки выбран Winbox, где будут наглядно отображаться изменения. Сами настройки будут задаваться командами в терминале Winbox. Физическое подключение для настройки осуществляется прямым соединением с интерфейсом Ether5.</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Немного рассуждений о том, что такое мультиван, проблема ли это или хитрые умники вокруг плетут сети заговоров</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Пытливый и внимательный админ, самостоятельно настраивая такую или подобную схему, вдруг неожиданно осознает, что оно и так нормально работает. Да-да, без этих ваших пользовательских таблиц маршрутизации и прочих route rules, коими пестрят большинство статей на эту тему. Проверим? <br /><br />Адресацию на интерфейсах и шлюзы по умолчанию настроить можем? Да: <br /><br />На ISP1 прописали адрес и шлюз с </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">distance=2</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> и </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">check-gateway=ping.</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />На ISP2 настройка dhcp клиента по умолчанию — соответственно distance будет равен единице.<br />На ISP3 в настройках pppoe клиента при </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">add-default-route=yes</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> ставим </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">default-route-distance=3</span><span style=" font-family:'Sans Serif'; font-size:9pt;">.<br /><br />NAT на выход прописать не забываем: <br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">/ip firewall nat add action=masquerade chain=srcnat out-interface-list=WAN</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />По итогу, у пользователей локалок котики весело грузятся через основного провайдера ISP2 и есть резервирование канала при помощи механизма </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">check gateway</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> </span><span style=" font-family:'Sans Serif'; font-size:9pt; vertical-align:super;">См. примечание 1</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />Пункт 1 задачи реализован. Где же мультиван со своими метками? Нет…<br /><br />Дальше. Нужно выпустить конкретных клиентов из LAN через ISP1:<br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">/ip firewall mangle add action=route chain=prerouting dst-address-list=!BOGONS \<br />passthrough=yes route-dst=100.66.66.1 src-address-list=Via_ISP1 <br />/ip firewall mangle add action=route chain=prerouting dst-address-list=!BOGONS \<br />passthrough=no route-dst=100.66.66.1 src-address=192.168.88.0/24 </span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />Пункты 2 и 3 задачи реализованы. Метки, марки, route rules, где вы?! <br /><br />Нужно дать доступ к любимому OpenVPN серверу с адресом 172.17.17.17 для клиентов из Интернет? Пожалуйста:<br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">/ip cloud set ddns-enabled=yes</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />Клиентам в качестве пира даем результат вывода: “</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">:put [ip cloud get dns-name]</span><span style=" font-family:'Sans Serif'; font-size:9pt;">”<br /><br />Прописываем проброс порта из инета:<br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">/ip firewall nat add action=dst-nat chain=dstnat dst-port=1194 \<br />in-interface-list=WAN protocol=udp to-addresses=172.17.17.17</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />Пункт 4 готов. <br /><br />Настраиваем фаервол и прочую безопасность для пункта 5, параллельно радуемся тому, что у пользователей уже все работает и тянемся к емкости с любимым напитком… <br />А! Туннели же еще забыли. <br /><br />l2tp-клиент, настроенный по нагугленной статье, до любимого голландского VDS поднялся? Да.<br />l2tp-сервер с IPsec поднялся и клиенты по ДНС-имени из IP Cloud(см выше.) цепляются? Да.<br />Откинувшись на спинку стула, прихлебывая напиток, лениво рассматриваем пункты 6 и 7 задачи. Думаем — а оно нам надо? Все ж и так работает (с)… Так вот если оно таки не надо, то на этом все. Мультиван реализован. <br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Что такое мультиван? Это подключение нескольких каналов Интернет к одному роутеру.</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> <br /><br />Дальше статью можно не читать, поскольку что там кроме выпендрежа сомнительной применимости может быть?<br /><br />С теми, кто остался, кто заинтересован пунктами 6 и 7 задачи, а также ощущает зуд перфекционизма, погружаемся глубже. <br /><br />Важнейшей задачей реализации мультиван является корректная маршрутизация трафика. А именно: независимо от того, в какой (или в какие)</span><span style=" font-family:'Sans Serif'; font-size:9pt; vertical-align:super;">См. примечание 3</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> канал(ы) провайдера смотрит маршрут по умолчанию на нашем роутере, он должен возвращать ответ именно в тот канал, с которого пакет пришел. Задача понятна. Проблема-то где? Ведь в простой локальной сети задача та же, но никто дополнительными настройками не заморачивается и беды не ощущает. Отличие в том, что любой маршрутизируемый узел в Интернет доступен через каждый из наших каналов, а не через строго конкретный, как в простой локалке. А “беда” заключается в том, что если к нам пришел запрос на IP-адрес ISP3, то в нашем случае ответ уйдет через канал ISP2, поскольку туда направлен шлюз по умолчанию. Уйдет и будет отброшен провайдером, как некорректный. С проблемой определились. Как ее решать? <br /><br />Решение разделим на три этапа:<br /><br /></span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Предварительная настройка. </span>На этом этапе будут заданы базовые настройки маршрутизатора: локальная сеть, фаервол, address lists, hairpin NAT и пр. </li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Мультиван.</span> На этом этапе будут промаркированы и рассортированы по таблицам маршрутизации нужные соединения.</li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Подключение к ISP.</span> На этом этапе будут настроены интерфейсы, обеспечивающие подключение к Интернет, задействована маршрутизация и механизм резервирования каналов Интернет.</li></ol>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание.</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> Три разных типа подключения к ISP выбраны специально для того, чтобы показать — ничего неразрешимого в настройке мультиван с динамическими адресами нет и продемонстрировать один из вариантов решения.</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; text-decoration: underline;">Важно!</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> Для переключения каналов по алгоритму заданному при помощи стоимости маршрутов </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">distance</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> используется механизм </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">check gateway.</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> </span><span style=" font-family:'Sans Serif'; font-size:9pt; vertical-align:super;">См. примечание 1</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> <br />Скрипты, приведенные в статье, к резервированию каналов отношения не имеют.<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">1. Предварительная настройка</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />1.1. Очищаем конфигурацию роутера командой:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/system reset-configuration skip-backup=yes no-defaults=yes</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />соглашаемся с “</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Dangerous! Reset anyway? [y/N]:</span><span style=" font-family:'Sans Serif'; font-size:9pt;">” и, после перезагрузки, подключаемся Winbox-ом по MAC. На данном этапе конфигурация и база пользователей очищены.<br /><br />1.2. Создаем нового пользователя:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/user add group=full name=knight password=ultrasecret comment=”Not horse”</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />логинимся под ним и удаляем дефолтного:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/user remove admin</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание.</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> Именно удаление а не отключение дефолтного пользователя автор считает более безопасным и рекомендует к применению.</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />1.3. Создаем базовые interface lists для удобства оперирования в файерволле, настройках discovery и прочих MAC серверах:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/interface list add name=WAN comment=&quot;For Internet&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/interface list add name=LAN comment=&quot;For Local Area&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Подписываем комментариями интерфейсы <br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/interface ethernet set ether1 comment=&quot;to ISP1&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/interface ethernet set ether2 comment=&quot;to ISP2&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/interface ethernet set ether3 comment=&quot;to ISP3&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/interface ethernet set ether4 comment=&quot;to LAN1&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/interface ethernet set ether5 comment=&quot;to LAN2&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />и заполняем interface lists:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/interface list member add interface=ether1 list=WAN comment=ISP1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/interface list member add interface=ether2 list=WAN comment=ISP2 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/interface list member add interface=ether3 list=WAN comment=&quot;to ISP3&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/interface list member add interface=ether4 list=LAN  comment=&quot;LAN1&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/interface list member add interface=ether5 list=LAN  comment=&quot;LAN2&quot;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:9pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание.</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> Писать понятные комментарии стоит потраченного на это времени плюс сильно облегчает траблшутинг и понимание конфигурации.<br /><br />Автор считает необходимым, в целях безопасности, добавить в interface list “WAN” интерфейс ether3, не смотря на то, что по нему не будет ходить протокол ip.<br /><br />Не забываем, что после того, как на ether3 будет поднят интерфейс PPP, его тоже нужно будет добавить в interface list “WAN”</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> <br /><br />1.4. Скрываем роутер от обнаружения соседства и управления из сетей провайдеров по МАС:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip neighbor discovery-settings set discover-interface-list=!WAN</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/tool mac-server set allowed-interface-list=LAN</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/tool mac-server mac-winbox set allowed-interface-list=LAN</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />1.5. Создаем минимально достаточный набор правил фильтра файрволла для защиты роутера:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall filter add action=accept chain=input \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">comment=&quot;Related Established Untracked Allow&quot; \</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">connection-state=established,related,untracked</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />(правило обеспечивает разрешение для установившихся и родственных соединений, которые инициированы как из подключенных сетей, так и самим роутером)<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall filter add action=accept chain=input \</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">comment=&quot;ICMP from ALL&quot; protocol=icmp</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />(пинг и не только пинг. Разрешен весь icmp на вход. Весьма полезно для нахождения проблем с MTU)<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall filter add action=drop chain=input comment=&quot;All other WAN Drop&quot; \</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">in-interface-list=WAN</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />(закрывающее цепочку input правило запрещает все остальное, что прилетает из Интернет)<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall filter add action=accept chain=forward \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">comment=&quot;Established, Related, Untracked allow&quot; \</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">connection-state=established,related,untracked</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />(правило разрешает установившиеся и родственные соединения, которые проходят сквозь роутер)<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall filter add action=drop chain=forward comment=&quot;Invalid drop&quot; \</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">connection-state=invalid</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />(правило сбрасывает соединения, с connection-state=invalid, проходящие сквозь роутер. Оно настоятельно рекомендовано Mikrotik, но в некоторых редких ситуациях может вызывать блокировку полезного трафика)<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall filter add action=drop chain=forward \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">comment=&quot;Drop all from WAN not DSTNATed&quot; connection-nat-state=!dstnat \</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">connection-state=new in-interface-list=WAN</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />(правило запрещает проходить сквозь роутер пакетам, которые идут из Интернет и не прошли процедуру dstnat. Это убережет локальные сети от злоумышленников, которые, находясь в одном широковещательном домене с нашими внешними сетями, пропишут в качестве шлюза наши внешние IP и, таким образом, попытаются “исследовать” наши локальные сети. )<br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание.</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> Примем за условие, что сети LAN1 и LAN2 являются доверенными и трафик между ними и с них не фильтруется.</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />1.6. Создаем список с перечнем не маршрутизируемых сетей:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall address-list</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">add address=0.0.0.0/8 comment=&quot;\&quot;This\&quot; Network&quot; list=BOGONS</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">add address=10.0.0.0/8 comment=&quot;Private-Use Networks&quot; list=BOGONS</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">add address=100.64.0.0/10 comment=&quot;Shared Address Space. RFC 6598&quot; list=BOGONS</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">add address=127.0.0.0/8 comment=Loopback list=BOGONS</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">add address=169.254.0.0/16 comment=&quot;Link Local&quot; list=BOGONS</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">add address=172.16.0.0/12 comment=&quot;Private-Use Networks&quot; list=BOGONS</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">add address=192.0.0.0/24 comment=&quot;IETF Protocol Assignments&quot; list=BOGONS</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">add address=192.0.2.0/24 comment=TEST-NET-1 list=BOGONS</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">add address=192.168.0.0/16 comment=&quot;Private-Use Networks&quot; list=BOGONS</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">add address=198.18.0.0/15 comment=&quot;Network Interconnect Device Benchmark Testing&quot;\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;"> list=BOGONS</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">add address=198.51.100.0/24 comment=TEST-NET-2 list=BOGONS</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">add address=203.0.113.0/24 comment=TEST-NET-3 list=BOGONS</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">add address=224.0.0.0/4 comment=Multicast list=BOGONS</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">add address=192.88.99.0/24 comment=&quot;6to4 Relay Anycast&quot; list=BOGONS</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">add address=240.0.0.0/4 comment=&quot;Reserved for Future Use&quot; list=BOGONS</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">add address=255.255.255.255 comment=&quot;Limited Broadcast&quot; list=BOGONS</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />(Это список адресов и сетей, которые не маршрутизируются в Интернет и, соответственно, мы тоже будем этому следовать. )<br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание.</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> Список может изменяться, поэтому советую периодически проверять актуальность.</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />1.7. Настраиваем DNS для самого роутера:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip dns set servers=1.1.1.1,8.8.8.8</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание.</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> В текущей версии ROS динамические серверы имеют приоритет перед статически заданными. Запрос на разрешение имени отсылается первому серверу по порядку следования в списке. На следующий сервер переход осуществляется при недоступности текущего. Таймаут большой — более 5 сек. Возврат обратно, при возобновлении работы “упавшего сервера”, автоматически не происходит. С учетом этого алгоритма и наличия мультивана, автор рекомендует не использовать серверы, выдаваемые провайдерами.</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />1.8. Настраиваем локальную сеть. <br />1.8.1. Конфигурируем статические IP-адреса на интерфейсах локальных сетей:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip address add interface=ether4 address=192.168.88.254/24 comment=&quot;LAN1 IP&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip address add interface=ether5 address=172.16.1.0/23 comment=&quot;LAN2 IP&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />1.8.2. Задаем правила маршрутов к нашим локальным сетям через главную таблицу маршрутизации:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip route rule add dst-address=192.168.88.0/24 table=main comment=”to LAN1”</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip route rule add dst-address=172.16.0.0/23 table=main comment=&quot;to LAN2&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание.</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> Это один из простых и быстрых способов получить доступ к адресам локальных сетей с соурсами внешних IP-адресов интерфейсов роутера, через которые не идет маршрут по умолчанию. </span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />1.8.3. Включаем Hairpin NAT для LAN1 и LAN2:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall nat add action=src-nat chain=srcnat comment=&quot;Hairpin to LAN1&quot; \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">out-interface=ether4 src-address=192.168.88.0/24 to-addresses=192.168.88.254</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall nat add action=src-nat chain=srcnat comment=&quot;Hairpin to LAN2&quot; \</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">out-interface=ether5 src-address=172.16.0.0/23 to-addresses=172.16.1.0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание.</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> Это позволяет получать доступ через внешний IP на свои ресурсы (dstnat), находясь внутри сети. </span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">2. Собственно, реализация того самого корректного мультиван</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Для решения задачи “отвечать туда откуда спросили” будем использовать два инструмента ROS: </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">connection mark</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> и </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">routing mark</span><span style=" font-family:'Sans Serif'; font-size:9pt;">. </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Connection mark</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> позволяет пометить нужное соединение и в дальнейшем работать с этой меткой, как условием для применения </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">routing mark</span><span style=" font-family:'Sans Serif'; font-size:9pt;">. А уже с </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">routing mark</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> возможно работать в </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">ip route</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> и </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">route rules</span><span style=" font-family:'Sans Serif'; font-size:9pt;">. С инструментами разобрались, теперь кужно решить какие соединения метить — раз, где именно метить — два. <br /><br />С первым все просто — мы должны пометить все соединения, которые приходят на роутер из Интернет по соответствующему каналу. В нашем случае это будут три метки (по количеству каналов): “conn_isp1”, “conn_isp2” и “conn_isp3”. <br /><br />Нюанс со вторым заключается в том, что входящие соединения будут двух видов: транзитные и те, которые предназначены самому роутеру. Механизм connection mark работает в таблице </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">mangle</span><span style=" font-family:'Sans Serif'; font-size:9pt;">. Рассмотрим движение пакета на упрощенной диаграмме, любезно собранной специалистами ресурса mikrotik-trainings.com (не реклама):<br /><br /></span><img src="image15729408795jhz1ioxpu.png" /><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />Следуя по стрелкам, мы видим, что пакет, приходящий в “</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">input interface</span><span style=" font-family:'Sans Serif'; font-size:9pt;">”, проходит по цепочке “</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Prerouting</span><span style=" font-family:'Sans Serif'; font-size:9pt;">” и только потом разделяется на транзитный и локальный в блоке “</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Routing Decision</span><span style=" font-family:'Sans Serif'; font-size:9pt;">”. Поэтому, для убиения двух зайцев, задействуем </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Connection Mark</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> в таблице </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Mangle Prerouting</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> цепочки </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Prerouting</span><span style=" font-family:'Sans Serif'; font-size:9pt;">.<br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;">. В ROS метки “Routing mark” указаны в разделе Ip/Routes/Rules как “Table”, а в остальных разделах, как “Routing Mark”. Сие может внести некую путаницу в понимание, но, по сути, это одно и то же, и является аналогом rt_tables в iproute2 на linux.</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />2.1. Метим входящие соединения от каждого из провайдеров:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall mangle add action=mark-connection chain=prerouting \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">comment=&quot;Connmark in from ISP1&quot; connection-mark=no-mark in-interface=ether1 \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">new-connection-mark=conn_isp1 passthrough=no</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:9pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall mangle add action=mark-connection chain=prerouting \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">comment=&quot;Connmark in from ISP2&quot; connection-mark=no-mark in-interface=ether2 \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">new-connection-mark=conn_isp2 passthrough=no</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:9pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall mangle add action=mark-connection chain=prerouting \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">comment=&quot;Connmark in from ISP3&quot; connection-mark=no-mark in-interface=pppoe-isp3 \</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">new-connection-mark=conn_isp3 passthrough=no</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание.</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> Для того, чтобы не метить уже помеченные соединения я использую условие connection-mark=no-mark вместо connection-state=new потому, что считаю это более корректным, как и отказ от drop invalid соединений в фильтре input. <br /><br />passthrough=no — потому, что в этом способе реализации перемаркировка исключена и для ускорения можно прервать перебор правил после первого же совпадения.</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />Следует иметь ввиду, что мы пока никак не вмешиваемся в маршрутизацию. Сейчас идут только этапы подготовки. Следующим этапом реализации будет обработка транзитного трафика, который возвращается по установившемуся соединению от адресата в локальной сети. Т.е. тех пакетов, которые (см диаграмму) прошли через роутер по пути:<br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">“Input Interface”=&gt;”Prerouting”=&gt;”Routing Decision”=&gt;”Forward”=&gt;”Post Routing”=&gt;”Output Interface”</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> и попали к своему адресату в локальной сети. <br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; text-decoration: underline;">Важно!</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> В ROS нет логического деления на внешний и внутренний интерфейсы. Если проследить путь движения ответного пакета по приведенной диаграмме, то он пройдет по тому же логическому пути, что и запрос:<br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">“Input Interface”=&gt;”Prerouting”=&gt;”Routing Decision”=&gt;”Forward”=&gt;”Post Routing”=&gt;”Output Interface”</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> просто для запроса “</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Input Interface</span><span style=" font-family:'Sans Serif'; font-size:9pt;">” был интерфейс ISP, а для ответа — LAN<br /><br />2.2. Направляем ответный транзитный трафик по соответствующим таблицам маршрутизации:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall mangle add action=mark-routing chain=prerouting \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">comment=&quot;Routemark transit out via ISP1&quot; connection-mark=conn_isp1 \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">dst-address-type=!local in-interface-list=!WAN new-routing-mark=to_isp1 passthrough=no</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:9pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall mangle add action=mark-routing chain=prerouting \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">comment=&quot;Routemark transit out via ISP2&quot; connection-mark=conn_isp2 \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">dst-address-type=!local in-interface-list=!WAN new-routing-mark=to_isp2 passthrough=no</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:9pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall mangle add action=mark-routing chain=prerouting \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">comment=&quot;Routemark transit out via ISP3&quot; connection-mark=conn_isp3 \</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">dst-address-type=!local in-interface-list=!WAN new-routing-mark=to_isp3 passthrough=no</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание. in-interface-list=!WAN — мы работаем только с трафиком из локальной сети и dst-address-type=!local не имеющим адрес назначения адреса интерфейсов самого роутера. <br /></span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />То же самое для локальных пакетов, которые пришли на роутер по пути:<br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">“Input Interface”=&gt;”Prerouting”=&gt;”Routing Decision”=&gt;”Input”=&gt;”Local Process”</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; text-decoration: underline;">Важно!</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> Ответ пойдет по следующему пути:<br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">”Local Process”=&gt;”Routing Decision”=&gt;”Output”=&gt;”Post Routing”=&gt;”Output Interface”<br /></span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />2.3. Направляем ответный локальный трафик по соответствующим таблицам маршрутизации:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall mangle add action=mark-routing chain=output \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">comment=&quot;Routemark local out via ISP1&quot; connection-mark=conn_isp1 \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">dst-address-type=!local new-routing-mark=to_isp1 passthrough=no</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:9pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall mangle add action=mark-routing chain=output \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">comment=&quot;Routemark local out via ISP2&quot; connection-mark=conn_isp2 \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">dst-address-type=!local new-routing-mark=to_isp2 passthrough=no</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:9pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall mangle add action=mark-routing chain=output \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">comment=&quot;Routemark local out via ISP3&quot; connection-mark=conn_isp3 \</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">dst-address-type=!local new-routing-mark=to_isp3 passthrough=no</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />На этом этапе задачу подготовки к отправке ответа в тот канал Интернет, с которого пришел запрос можно считать решенной. Все помечено, промаркировано и готово маршрутизироваться. <br />Отличным “побочным” эффектом такой настройки является возможность работы проброса портов DSNAT с обоих (ISP2, ISP3) провайдеров одновременно. Не на всех, так как на ISP1 у нас не маршрутизируемый адрес. Этот эффект важен, например, для почтового сервера с двумя MХ, которые смотрят в разные каналы Интернет.<br /><br />Для устранения нюансов работы локальных сетей с внешними IP роутера используем решения из пп. 1.8.2 и 3.1.2.6.<br /><br />Кроме того, можно задействовать инструмент с маркировками и для решения пункта 3 задачи. Реализуем так:<br /><br />2.4. Направляем трафик от локальных клиентов из списков маршрутизации в соответствующие таблицы:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall mangle add action=mark-routing chain=prerouting \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">comment=&quot;Address List via ISP1&quot; dst-address-list=!BOGONS new-routing-mark=to_isp1 \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">passthrough=no src-address-list=Via_ISP1</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:9pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall mangle add action=mark-routing chain=prerouting \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">comment=&quot;Address List via ISP2&quot; dst-address-list=!BOGONS new-routing-mark=to_isp2 \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">passthrough=no src-address-list=Via_ISP2</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:9pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall mangle add action=mark-routing chain=prerouting \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">comment=&quot;Address List via ISP3&quot; dst-address-list=!BOGONS new-routing-mark=to_isp3 \</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">passthrough=no src-address-list=Via_ISP3</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />По итогу, это выглядит приблизительно так:<br /><br /></span><img src="image1572940879amdgmadw1w.png" /><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">3. Настраиваем подключение к ISP и задействуем маршрутизацию по маркам</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />3.1. Настраиваем подключение к ISP1:<br />3.1.1. Конфигурируем статический IP-адрес:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip address add interface=ether1 address=100.66.66.2/30 comment=&quot;ISP1 IP&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />3.1.2. Настраиваем статическую маршрутизацию: <br />3.1.2.1. Добавляем “аварийный” маршрут по умолчанию:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip route add comment=&quot;Emergency route&quot; distance=254 type=blackhole</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание.</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> Этот маршрут позволяет трафику от локальных процессов проходить этап Route Decision независимо от состояния каналов любого из провайдеров. Нюанс исходящего локального трафика заключается в том, что чтобы пакет хоть куда-то двинулся, в основной таблице маршрутизации должен присутствовать активный маршрут до шлюза по умолчанию. Если его нет, то пакет просто будет уничтожен.</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> <br /><br />В качестве расширения инструмента </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">check gateway</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> для более глубокого анализа состояния канала предлагаю использовать метод рекурсивных маршрутов. Суть метода заключается в том, что мы указываем маршрутизатору искать путь к своему шлюзу не напрямую, а через промежуточный шлюз. В качестве таких “проверочных” шлюзов будут выбраны 4.2.2.1, 4.2.2.2 и 4.2.2.3 соответственно для ISP1, ISP2 и ISP3.<br /><br />3.1.2.2. Маршрут до “проверочного” адреса:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip route add check-gateway=ping comment=&quot;For recursion via ISP1&quot; \ </span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">distance=1 dst-address=4.2.2.1 gateway=100.66.66.1 scope=10</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание.</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> Значение scope понижаем до дефолтного в ROS target scope, чтобы использовать в дальнейшем 4.2.2.1 в качестве рекурсивного шлюза. Подчеркиваю: scope маршрута до “проверочного” адреса должно быть меньше или равно target scope того маршрута, который будет ссылаться на проверочный.</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />3.1.2.3. Рекурсивный маршрут по умолчанию для трафика без routing mark:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip route add check-gateway=ping comment=&quot;Unmarked via ISP1&quot; \</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">distance=2 gateway=4.2.2.1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание.</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> Значение distance=2 используется потому, что ISP1 по условиям задачи заявлен как первый резервный. </span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />3.1.2.4. Рекурсивный маршрут по умолчанию для трафика c routing mark “to_isp1”:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip route add comment=&quot;Marked via ISP1 Main&quot; distance=1 gateway=4.2.2.1 \</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">routing-mark=to_isp1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание.</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> Собственно, здесь мы наконец-то начинаем пользоваться плодами той подготовительной работы, что была проведена в пункте 2.<br /><br />По этому маршруту весь трафик, который имеет mark route “to_isp1”, будет направлен на шлюз первого провайдера не зависимо от того, какой в данный момент активен шлюз по умолчанию для таблицы main.</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />3.1.2.5. Первый резервный рекурсивный маршрут по умолчанию для маркированного трафика провайдеров ISP2 и ISP3:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip route add comment=&quot;Marked via ISP2 Backup1&quot; distance=2 gateway=4.2.2.1 \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">routing-mark=to_isp2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip route add comment=&quot;Marked via ISP3 Backup1&quot; distance=2 gateway=4.2.2.1 \</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">routing-mark=to_isp3</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание.</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> Эти маршруты нужны, в том числе, для резервирования трафика с локальных сетей, которые состоят членами address list “to_isp*”’</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />3.1.2.6. Прописываем маршрут для локального трафика роутера в интернет через ISP1:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip route rule add comment=&quot;From ISP1 IP to Inet&quot; src-address=100.66.66.2 table=to_isp1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание.</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> В сочетании с правилами из пункта 1.8.2, обеспечивается выход в нужный канал с заданным соурсом. Это является критичным для построения туннелей, в которых задается IP-адрес локальной стороны(EoIP, IP-IP, GRE). Поскольку правила в ip route rules выполняются сверху вниз, до первого совпадения условий, то данное правило должно быть после правил из пункта 1.8.2.</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />3.1.3. Прописываем правило NAT для исходящего трафика:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall nat add action=src-nat chain=srcnat comment=&quot;NAT via ISP1&quot; \ </span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">ipsec-policy=out,none out-interface=ether1 to-addresses=100.66.66.2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание.</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> NATим все выходящее, кроме того, что попадает в политики IPsec. Я стараюсь не использовать action=masquerade без крайней необходимости. Оно работает медленнее и более ресурсоемко, чем src-nat, поскольку для каждого нового соединения вычисляет адрес для NAT.</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />3.1.4. Отправляем клиентов из списка, которым запрещен выход через остальных провайдеров сразу на шлюз провайдера ISP1.<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip firewall mangle add action=route chain=prerouting \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">comment=&quot;Address List via ISP1 only&quot; dst-address-list=!BOGONS passthrough=no \</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">route-dst=100.66.66.1 src-address-list=Via_only_ISP1 place-before=0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание.</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> action=route имеет более высокий приоритет и применяется раньше остальных правил маршрутизации.<br /><br />place-before=0 — помещает наше правило первым в списке.</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />3.2. Настраиваем подключение к ISP2.<br /><br />Поскольку провайдер ISP2 настройки нам выдает по DHCP, разумно необходимые изменения делать скриптом, который стартует при срабатывании DHCP клиента:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ip dhcp-client</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">add add-default-route=no disabled=no interface=ether2 script=&quot;:if (\$bound=1) do={\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n    /ip route add check-gateway=ping comment=\&quot;For recursion via ISP2\&quot; \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">           distance=1 dst-address=4.2.2.2/32 gateway=\$\&quot;gateway-address\&quot; scope=10\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n    /ip route add check-gateway=ping comment=\&quot;Unmarked via ISP2\&quot; \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">           distance=1 gateway=4.2.2.2;\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n    /ip route add comment=\&quot;Marked via ISP2 Main\&quot; distance=1 gateway=4.2.2.2 \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">           routing-mark=to_isp2;\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n    /ip route add comment=\&quot;Marked via ISP1 Backup1\&quot; distance=2 \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">           gateway=4.2.2.2 routing-mark=to_isp1;\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n    /ip route add comment=\&quot;Marked via ISP3 Backup2\&quot; distance=3 \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">           gateway=4.2.2.2 routing-mark=to_isp3;\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n    /ip firewall nat add action=src-nat chain=srcnat ipsec-policy=out,none \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">           out-interface=\$\&quot;interface\&quot; to-addresses=\$\&quot;lease-address\&quot; \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">           comment=\&quot;NAT via ISP2\&quot; place-before=1;\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n    if ([/ip route rule find comment=\&quot;From ISP2 IP to Inet\&quot;] =\&quot;\&quot;) do={\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n        /ip route rule add comment=\&quot;From ISP2 IP to Inet\&quot; \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">               src-address=\$\&quot;lease-address\&quot; table=to_isp2 \r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n    } else={\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n       /ip route rule set [find comment=\&quot;From ISP2 IP to Inet\&quot;] disabled=no \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">              src-address=\$\&quot;lease-address\&quot;\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n    }      \r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n} else={\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n   /ip firewall nat remove  [find comment=\&quot;NAT via ISP2\&quot;];\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n   /ip route remove [find comment=\&quot;For recursion via ISP2\&quot;];\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n   /ip route remove [find comment=\&quot;Unmarked via ISP2\&quot;];\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n   /ip route remove [find comment=\&quot;Marked via ISP2 Main\&quot;];\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n   /ip route remove [find comment=\&quot;Marked via ISP1 Backup1\&quot;];\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n   /ip route remove [find comment=\&quot;Marked via ISP3 Backup2\&quot;];\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n   /ip route rule set [find comment=\&quot;From ISP2 IP to Inet\&quot;] disabled=yes\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n}\r\</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n&quot; use-peer-dns=no use-peer-ntp=no</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Сам скрипт в окне Winbox:<br /><br /></span><img src="image1572940879z1a9x607k0.png" /><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание.</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> Первая часть скрипта срабатывает при успешном получении аренды, вторая — после освобождения аренды.</span><span style=" font-family:'Sans Serif'; font-size:9pt; vertical-align:super;">См. примечание 2</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />3.3. Настраиваем подключение к провайдеру ISP3.<br /><br />Поскольку провайдер настройки нам выдает динамические, то разумно необходимые изменения делать скриптами, которые стартуют после поднятия и после падения интерфейса ppp. <br /><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание.</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> Интерфейс ppp может быть указан в качестве шлюза вместо IP-адреса. Однако в таком варианте рекурсивный маршрут задействовать не получится. Посему мы получаем в переменную IP-адрес стороны провайдера и используем ее дальше точно так же, как и для остальных провайдеров</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />3.3.1. Сначала конфигурируем профиль:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/ppp profile</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">add comment=&quot;for PPPoE to ISP3&quot; interface-list=WAN name=isp3_client \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">on-down=&quot;/ip firewall nat remove  [find comment=\&quot;NAT via ISP3\&quot;];\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n/ip route remove [find comment=\&quot;For recursion via ISP3\&quot;];\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n/ip route remove [find comment=\&quot;Unmarked via ISP3\&quot;];\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n/ip route remove [find comment=\&quot;Marked via ISP3 Main\&quot;];\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n/ip route remove [find comment=\&quot;Marked via ISP1 Backup2\&quot;];\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n/ip route remove [find comment=\&quot;Marked via ISP2 Backup2\&quot;];\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n/ip route rule set [find comment=\&quot;From ISP3 IP to Inet\&quot;] disabled=yes;&quot; \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">on-up=&quot;/ip route add check-gateway=ping comment=\&quot;For recursion via ISP3\&quot; distance=1 \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    dst-address=4.2.2.3/32 gateway=\$\&quot;remote-address\&quot; scope=10\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n/ip route add check-gateway=ping comment=\&quot;Unmarked via ISP3\&quot; distance=3 \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    gateway=4.2.2.3;\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n/ip route add comment=\&quot;Marked via ISP3 Main\&quot; distance=1 gateway=4.2.2.3 \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    routing-mark=to_isp3;\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n/ip route add comment=\&quot;Marked via ISP1 Backup2\&quot; distance=3 gateway=4.2.2.3 \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    routing-mark=to_isp1;\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n/ip route add comment=\&quot;Marked via ISP2 Backup2\&quot; distance=3 gateway=4.2.2.3 \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    routing-mark=to_isp2;\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n/ip firewall mangle set [find comment=\&quot;Connmark in from ISP3\&quot;] \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    in-interface=\$\&quot;interface\&quot;;\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n/ip firewall nat add action=src-nat chain=srcnat ipsec-policy=out,none \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    out-interface=\$\&quot;interface\&quot; to-addresses=\$\&quot;local-address\&quot; \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    comment=\&quot;NAT via ISP3\&quot; place-before=1;\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \nif ([/ip route rule find comment=\&quot;From ISP3 IP to Inet\&quot;] =\&quot;\&quot;) do={\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n   /ip route rule add comment=\&quot;From ISP3 IP to Inet\&quot; \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    src-address=\$\&quot;local-address\&quot; table=to_isp3 \r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n} else={\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n   /ip route rule set [find comment=\&quot;From ISP3 IP to Inet\&quot;] disabled=no \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    src-address=\$\&quot;local-address\&quot;\r\</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n};\r\</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">    \n&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Сам скрипт в окне Winbox:<br /><br /></span><img src="image1572940879ypkv51e9f3.png" /><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">Замечание.</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"> Строка <br /></span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600; font-style:italic;">/ip firewall mangle set [find comment=«Connmark in from ISP3»] in-interface=$«interface»;</span><span style=" font-family:'Sans Serif'; font-size:9pt; font-style:italic;"><br />позволяет корректно обрабатывать переименование интерфейса, поскольку работает с его кодом а не отображаемым именем.</span><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /><br />3.3.2. Теперь, используя профиль, создаем подключение ppp:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/interface pppoe-client add allow=mschap2 comment=&quot;to ISP3&quot; disabled=no \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">interface=ether3 name=pppoe-isp3 password=isp3_pass profile=isp3_client \</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">user=isp3_client</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />В качестве последнего штриха настроим часы:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">/system ntp client set enabled=yes \</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:9pt;">server-dns-names=0.pool.ntp.org,1.pool.ntp.org,2.pool.ntp.org</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Для тех, кто дочитал до конца</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br />Предложенный способ реализации мультиван — есть личное предпочтение автора и не является единственно возможным. Инструментарий ROS обширен и гибок, что с одной стороны вызывает сложности для начинающих, с другой — причина популярности. Изучайте, пробуйте, открывайте для себя новые инструменты и решения. Например, в качестве применения полученных знаний, можно в данной реализации мультиван заменить инструмент </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Сheck-gateway</span><span style=" font-family:'Sans Serif'; font-size:9pt;"> с рекурсивными маршрутами на </span><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Netwatch</span><span style=" font-family:'Sans Serif'; font-size:9pt;">.<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt; font-weight:600;">Примечания</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"><br /></span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; font-style:italic;">Check-gateway</span><span style=" font-style:italic;"> — механизм, который позволяет деактивировать маршрут после двух подряд не успешных проверок шлюза на доступность. Проверка осуществляется раз в 10 секунд, плюс таймаут ответа. Итого, фактический тайминг переключения лежит в диапазоне 20-30 секунд. Если такой тайминг переключения не достаточен — есть вариант воспользоваться инструментом </span><span style=" font-weight:600; font-style:italic;">Netwatch</span><span style=" font-style:italic;">, где таймер проверки можно задавать вручную. <br />Механизм </span><span style=" font-weight:600; font-style:italic;">Check-gateway</span><span style=" font-style:italic;"> не срабатывает при периодических потерях пакетов в канале. <br /><br /></span><span style=" font-weight:600; font-style:italic; text-decoration: underline;">Важно!</span><span style=" font-style:italic;"> Деактивация основного маршрута влечет за собой деактивацию всех остальных маршрутов, которые на него ссылаются. Поэтому для них указывать </span><span style=" font-weight:600; font-style:italic;">check-gateway=ping</span><span style=" font-style:italic;"> нет необходимости.</span></li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">Бывает, что в механизме работы DHСP происходит сбой, который выглядит, как клиент подвисший в состоянии renew. В таком случае вторая часть скрипта не отработает, но корректно ходить трафику не помешает, поскольку состояние отслеживает соответствующий рекурсивный маршрут.</span></li>
<li style=" font-family:'Sans Serif'; font-size:9pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; font-style:italic;">ECMP (Equal Cost Multi-Path)</span><span style=" font-style:italic;"> — в ROS есть возможность задать маршрут с несколькими шлюзами и одинаковой distance. В таком случае соединения будут распределяться по каналам, используя алгоритм round robin, пропорционально количеству указанных шлюзов.</span></li></ol></body></html>